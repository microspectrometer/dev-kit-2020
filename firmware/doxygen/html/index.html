<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>firmware: Main Page</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="Chromation_colored.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">firmware
   &#160;<span id="projectnumber">v0.1.2</span>
   </div>
   <div id="projectbrief">Chromation Spectrometer Dev-Kit</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">firmware Documentation</div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md0">How to use the firmware documentation</a></li>
<li class="level1"><a href="#autotoc_md1">Related dev-kit documentation</a></li>
<li class="level1"><a href="#autotoc_md2">Chromation dev-kit hardware</a><ul><li class="level2"><a href="#autotoc_md3">Spectrometer chip programmable registers</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md4">Serial communication and the Python API</a><ul><li class="level2"><a href="#autotoc_md5">Protocol is in a JSON file</a></li>
<li class="level2"><a href="#autotoc_md6">Develop and test</a></li>
<li class="level2"><a href="#autotoc_md7">Protocol example</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="md_doxygen_mainpage"></a></p>
<h1><a class="anchor" id="autotoc_md0"></a>
How to use the firmware documentation</h1>
<p>All the useful firmware information is under <a href="files.html">Files</a>.</p>
<h1><a class="anchor" id="autotoc_md1"></a>
Related dev-kit documentation</h1>
<p>The firmware runs on the Chromation dev-kit. Documentation for the dev-kit is here:</p>
<p><a href="https://microspectrometer.github.io/dev-kit-2020/">https://microspectrometer.github.io/dev-kit-2020/</a></p>
<p>All dev-kit hardware and firmware files are open-source and are available from the GitHub repository:</p>
<p><a href="https://github.com/microspectrometer/dev-kit-2020">https://github.com/microspectrometer/dev-kit-2020</a></p>
<h1><a class="anchor" id="autotoc_md2"></a>
Chromation dev-kit hardware</h1>
<p>The dev-kit has two ATmega328 microcontrollers and a spectrometer chip.</p>
<p>The firmware is for the Flash memory in those two microcontrollers:</p>
<ul>
<li>the microcontroller on the <code>vis-spi-out</code> PCB handles spectrometer configuration and readout</li>
<li>the microcontroller on the <code>usb-bridge</code> PCB simply passes messages between the application on the host computer (e.g., a Python script) and the 5-wire SPI interface on the <code>vis-spi-out</code> PCB</li>
</ul>
<p>Jump to the <code>main()</code> <code>.c</code> file for the two microcontrollers:</p>
<ul>
<li><a href="usb-bridge_8c_source.html">usb-bridge/src/usb-bridge.c</a></li>
<li><a href="vis-spi-out_8c_source.html">vis-spi-out/src/vis-spi-out.c</a></li>
</ul>
<p>There is no firmware for the spectrometer chip itself, but the chip does have programmable registers.</p>
<h2><a class="anchor" id="autotoc_md3"></a>
Spectrometer chip programmable registers</h2>
<p>The programmable registers are part of the LIS-770i, the CMOS image sensor used in the spectrometer chip. These registers initialize in an unknown state and must be written to after the spectrometer chip is powered on.</p>
<p>All registers are programmed at once by sending the LIS-770i a 28-bit word. The value of this 28-bit word determines:</p>
<ul>
<li>pixel binning (choosing between 7.8µm and 15.6µm pitch)</li>
<li>voltage gain</li>
<li>which pixels are active</li>
</ul>
<p>See details in <a href="LisConfig_8h.html">Lis.h</a>.</p>
<p>The dev-kit firmware writes these registers with recommended default values when the dev-kit is powered on. The recommended defaults are to turn on pixel binning, set gain to 1x, and turn on all pixels.</p>
<p>The <a href="https://pypi.org/project/microspec/">microspec</a> Python API includes command <code>setSensorConfig()</code> for applications to write to these registers, but most applications <b>do not require</b> changing these register values:</p>
<ul>
<li>the recommended value for pixel binning is based on the optical design of the spectrometer</li>
<li>the recommended 1x gain is based on the dev-kit's analog front-end (i.e., the choice of ADC and ADC reference voltage) &ndash; given this design, increasing the gain reduces dynamic range without improving SNR</li>
</ul>
<h1><a class="anchor" id="autotoc_md4"></a>
Serial communication and the Python API</h1>
<h2><a class="anchor" id="autotoc_md5"></a>
Protocol is in a JSON file</h2>
<p>The serial communication protocol is defined in the JSON file <a href="https://github.com/microspectrometer/microspec/blob/master/cfg/microspec.json">microspec.json</a>:</p>
<ul>
<li>The firmware follows the <a href="https://github.com/microspectrometer/microspec/blob/master/cfg/microspec.json">microspec.json</a> serial communication protocol.</li>
<li>PyPI project <a href="https://pypi.org/project/microspec/">microspec</a> defines a USB interface to the dev-kit. This interface is a <code>class</code> that is auto-generated from <a href="https://github.com/microspectrometer/microspec/blob/master/cfg/microspec.json">microspec.json</a>.</li>
</ul>
<h2><a class="anchor" id="autotoc_md6"></a>
Develop and test</h2>
<p>Install Python and the <a href="https://pypi.org/project/microspec/">microspec</a> package to develop and test the firmware:</p>
<div class="fragment"><div class="line">$ pip install microspec</div>
</div><!-- fragment --><p>The Python REPL is an easy way to quickly test commands. Details are in the <a href="https://microspec-api.readthedocs.io/en/latest/microspec.commands.html">documentation</a>. The <a href="https://pypi.org/project/microspec/">microspec</a> package also provides a command-line utility to send commands without opening a Python REPL. This is useful when running single dev-kit commands from a text editor like Vim or Emacs.</p>
<p>To quickly check that the firmware and Python API are in complete agreement about the serial communication protocol, run <a href="https://github.com/microspectrometer/dev-kit-2020/blob/master/python/microspeclib/system-tests.py">system-tests.py</a>. This script runs all the serial commands and checks for the expected responses from the dev-kit. The script is organized into classes, one class per serial command. The methods in each class are the different scenarios for testing the serial command (the different arguments the command might be called with).</p>
<h2><a class="anchor" id="autotoc_md7"></a>
Protocol example</h2>
<p>TODO: Add an example with the <code>usb-bridge</code> and <code>vis-spi-out</code> firmware that corresponds to one of the commands in the JSON file, and how the resulting call-and-response looks from Python. </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
