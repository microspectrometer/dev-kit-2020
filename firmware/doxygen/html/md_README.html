<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>firmware: Chromation dev-kit firmware</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">firmware
   &#160;<span id="projectnumber">v0</span>
   </div>
   <div id="projectbrief">Protocol compatible with Python package microspeclib</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Chromation dev-kit firmware </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><code>firmware</code> consists of C source files and build scripts. The build scripts are for two targets:</p>
<ul>
<li>the microcontroller target &ndash; this outputs AVR assembly <code>.elf</code></li>
<li>the unit-test target &ndash; this outputs an executable that runs from a command line on the development computer</li>
</ul>
<p><code>firmware</code> also contains shell scripts for programming the EEPROM in the FTDI chip on the <code>usb-bridge</code> PCB.</p>
<p>``` firmware ├── README.md ├── Makefile ├── common.mk &ndash; Makefile common to <code>vis-spi-out</code> and <code>usb-bridge</code> ├── Doxyfile &ndash; Doxygen settings for firmware documentation ├── kits &ndash; Kit data, sorted by serial number │&#160;&#160; ├── 0911-03 &ndash; example kit serial number │&#160;&#160; ├── ... │&#160;&#160; ... ├── lib │&#160;&#160; ├── build │&#160;&#160; ├── Makefile │&#160;&#160; ├── src │&#160;&#160; └── test ├── usb-bridge │&#160;&#160; ├── build │&#160;&#160; ├── Makefile │&#160;&#160; ├── src │&#160;&#160; └── test └── vis-spi-out &#160;&#160; ├── build &#160;&#160; ├── Makefile &#160;&#160; ├── src &#160;&#160; └── test </p><div class="fragment"><div class="line">The top-level also contains assorted scripts and help messages</div>
<div class="line">that are of no interest to most users:</div>
</div><!-- fragment --><p>firmware ├── help.man &ndash; Help msg printed when running <code>make</code> with no args ├── help-setup.man &ndash; Help msg to setup firmware toolchain ├── help-board-common.man &ndash; Help msg for <code>make</code> from board folder with no args ├── help-build.man &ndash; Help msg for build from source ├── help-flash.man &ndash; Help msg for programming Flash memory ├── help-ftdi.man &ndash; Help msg for programming FTDI EEPROM ├── help-fuses.man &ndash; Help msg for programming MCU AVR fuses ├── devcnt.sh &ndash; bash script to parse temporary file <code>devscan</code> ├── ftcfg.xml &ndash; Template config for FTDI EEPROM ├── kitnum.py &ndash; Python script to generate new serial numbers ├── kitnum.sh &ndash; bash script CLI to generate XML for new serial numbers ├── progkitnum.sh &ndash; bash script to write the FTDI EEPROM ├── uservars.mk ... └── writexml.py ```</p>
<p>The dev-kit firmware is written in C.</p>
<p>[ ] View Doxygen documentation</p>
<h1>Dev-kit Flash memory programming</h1>
<h2>Overview</h2>
<p>Use <code>make</code> to program:</p>
<ul>
<li>the FTDI FT221X EEPROM<ul>
<li>the kit serial number</li>
<li>configuration for how the USB Bridge IC behaves</li>
</ul>
</li>
<li>the two ATmega328 microcontrollers<ul>
<li>Flash memory</li>
<li>fuses</li>
</ul>
</li>
</ul>
<p>First time setup of a dev kit requires:</p>
<ul>
<li>two <code>make</code> commands for the FTDI chip<ul>
<li><code>$ make kitnum</code></li>
<li><code>$ make progkitnum</code></li>
</ul>
</li>
<li>two <code>make</code> commands for each microcontroller.<ul>
<li><code>$ make fuses</code></li>
<li><code>$ make flash</code></li>
</ul>
</li>
</ul>
<p>Once a kit has been programmed, updating firmware is just the Flash:</p>
<ul>
<li><code>$ make flash</code></li>
</ul>
<h2>Enter the repo</h2>
<p>Open bash (the Cygwin mintty terminal):</p>
<div class="fragment"><div class="line">&gt; bash</div>
</div><!-- fragment --><p>Enter the local directory for this repo</p>
<div class="fragment"><div class="line">$ cd ~/chromation/dev-kit-2020/</div>
</div><!-- fragment --><p>Enter the <code>firmware</code> folder</p>
<div class="fragment"><div class="line">$ cd firmware/</div>
</div><!-- fragment --><h2>Program the EEPROM</h2>
<p>Hardware setup:</p>
<ul>
<li>connect the dev-kit over USB</li>
<li>if AtmelICE is connected, power it OFF</li>
</ul>
<p>Check the dev-kit is visible:</p>
<div class="fragment"><div class="line">$ make scan</div>
<div class="line">Scanning connected USB devices...</div>
<div class="line">Device 0: FT X Series, ChromationSpect-0911-03, CHROMATION091103</div>
<div class="line">OK: One device found.</div>
</div><!-- fragment --><p>Program the serial number and configure the FTDI EEPROM:</p>
<div class="fragment"><div class="line">$ make kitnum</div>
<div class="line"> </div>
<div class="line">Serial number: 1182-XX</div>
<div class="line">Enter two digits to replace XX</div>
<div class="line">...</div>
</div><!-- fragment --><p>*<code>make kitnum</code> creates a sub-folder in <code>kits/</code> and the EEPROM config file for this kit*</p>
<div class="fragment"><div class="line">$ make progkitnum</div>
<div class="line">...</div>
<div class="line">Enter ENTIRE kit serial number, for example: 1182-01</div>
<div class="line">XXXX-XX: 1182-03</div>
<div class="line">...</div>
</div><!-- fragment --><h2>Program the fuses and the Flash</h2>
<ul>
<li>connect the <em>Atmel-ICE</em> programmer over USB and ISP</li>
<li>flip the switches to program the <code>usb-bridge</code><ul>
<li>slide black switch ''left''</li>
<li>slide white switch ''right''</li>
</ul>
</li>
</ul>
<p>Program the usb-bridge microcontroller:</p>
<div class="fragment"><div class="line">$ cd usb-bridge/</div>
<div class="line">$ make fuses</div>
<div class="line"> </div>
<div class="line">atprogram.exe --tool atmelice --interface isp --device atmega328p \</div>
<div class="line">        write --verify --fuses --values F7D9FF</div>
<div class="line">Firmware check OK</div>
<div class="line">Verification of write OK</div>
<div class="line">Write completed successfully.</div>
<div class="line"> </div>
<div class="line">$ make flash</div>
<div class="line"> </div>
<div class="line">atprogram.exe --tool atmelice --interface isp \</div>
<div class="line">        --device atmega328p program --chiperase --verify --file build/usb-bridge.elf</div>
<div class="line">Firmware check OK</div>
<div class="line">Programming and verification completed successfully.</div>
<div class="line">avr-size build/usb-bridge.elf</div>
<div class="line">   text    data     bss     dec     hex filename</div>
<div class="line">   2980      96    1577    4653    122d build/usb-bridge.elf</div>
</div><!-- fragment --><p>Hardware setup:</p>
<ul>
<li>flip the switches to program the <code>vis-spi-out</code><ul>
<li>slide white switch ''left''</li>
</ul>
</li>
</ul>
<p>Program the vis-spi-out microcontroller:</p>
<div class="fragment"><div class="line">$ cd ../vis-spi-out/</div>
<div class="line"> </div>
<div class="line">$ make fuses</div>
<div class="line"> </div>
<div class="line">atprogram.exe --tool atmelice --interface isp --device atmega328p \</div>
<div class="line">        write --verify --fuses --values F7D9FF</div>
<div class="line">Firmware check OK</div>
<div class="line">Verification of write OK</div>
<div class="line">Write completed successfully.</div>
<div class="line"> </div>
<div class="line">$ make flash</div>
<div class="line"> </div>
<div class="line">atprogram.exe --tool atmelice --interface isp \</div>
<div class="line">        --device atmega328p program --chiperase --verify --file build/vis-spi-out.elf</div>
<div class="line">Firmware check OK</div>
<div class="line">Programming and verification completed successfully.</div>
<div class="line">avr-size build/vis-spi-out.elf</div>
<div class="line">   text    data     bss     dec     hex filename</div>
<div class="line">   3754     352    1577    5683    1633 build/vis-spi-out.elf</div>
</div><!-- fragment --><p>For first time setup, see the <b>Setup instructions</b> below.</p>
<h1>Dev-kit programming setup</h1>
<p>:rainbow: See the <a href="https://microspectrometer.github.io/flash-avr-firmware/">TiddlyWiki</a> for instructions to setup the firmware (Flash/EEPROM) programming toolchain.</p>
<p>Open tiddler <b>Use AtmelStudio</b>:</p>
<p><img src="open-tiddler.PNG" alt="Screenshot of chromation-notebook TiddlyWiki" class="inline"/></p>
<ul>
<li>type <em>Use AtmelStudio</em> in the search bar on the right</li>
<li>click on the link <b>Use AtmelStudio</b> in the search results</li>
<li>the tiddler opens on the left, as shown</li>
</ul>
<p>This tiddler is the starting point for downloading the old firmware onto the dev-kit.</p>
<p>The tiddler contains links to external websites and links to other tiddlers in the TiddlyWiki.</p>
<p>Also see tiddler <b>Program FTDI Chips with FT_PROG</b>. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
