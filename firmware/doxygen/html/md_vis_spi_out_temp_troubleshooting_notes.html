<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>firmware: temp-troubleshooting-notes</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="Chromation_colored.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">firmware
   &#160;<span id="projectnumber">v0.1.2</span>
   </div>
   <div id="projectbrief">Chromation Spectrometer Dev-Kit</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">temp-troubleshooting-notes </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Things I'm figuring out:</p>
<ul>
<li>gcc linker error <code>undefined reference</code> means the object file is missing</li>
<li>Needed both the .o and the <code>_faked.o</code>:<ul>
<li>SpiSlave.o and <code>SpiSlave_faked.o</code></li>
<li>Lis.o and <code>Lis_faked.o</code></li>
</ul>
</li>
<li>multiple inclusion of <a class="el" href="Lis_8h.html">Lis.h</a> in different translation units causes mutliple object files to get definitions which cause the multiple definition (linker) error<ul>
<li>VisCmd.o gets definition of <code>exposure_ticks</code> from <a class="el" href="Lis_8h.html">Lis.h</a></li>
<li>Lis.o gets definition of <code>exposure_ticks</code> from <a class="el" href="Lis_8h.html">Lis.h</a></li>
</ul>
</li>
<li>But how did <a class="el" href="vis-spi-out_8c.html">vis-spi-out.c</a> (build for AVR) solve this problem?<ul>
<li>The build recipe links VisCmd.o and Lis.o</li>
<li>So it should have the same problem</li>
<li>The only difference I see is that the build for the .elf already has a build for the main() object file and it's just linking all of them, but that really shouldn't matter</li>
<li>Could this be some crazy bug I've been getting away with?</li>
<li>[x] It seems I should have declared <code>exposure_ticks</code> extern in <a class="el" href="Lis_8h.html">Lis.h</a>, and then moved "ownership for defining the symbol" to <a class="el" href="Lis_8c_source.html">Lis.c</a>, same for all the other multiple definition errors<ul>
<li>[x] do it for <a class="el" href="Lis_8h.html">Lis.h</a>: <code>exposure_ticks</code></li>
<li>[x] do it for everything in <a class="el" href="AutoExpose_8h.html">AutoExpose.h</a></li>
<li>[x] do it for <code>frame</code> in <a class="el" href="VisCmd_8h.html">VisCmd.h</a><ul>
<li>I made the declaration <code>frame[]</code></li>
<li>the size of the frame array is in <a class="el" href="VisCmd_8c_source.html">VisCmd.c</a></li>
<li>check I have a test that this size is picked up</li>
</ul>
</li>
</ul>
</li>
<li>First see if switching from mixed compile/link recipe to a link-only recipe fixes this problem.<ul>
<li>NO! It does not solve this problem. Good, that was what I expected.</li>
</ul>
</li>
<li>I must implement it the way I described. It doesn't make sense to me why separating the linking and compiling recipes would fix this. It didn't fix it for gcc. But somehow avr-gcc is OK with this. I no longer trust that the AVR code is being built correctly. This might explain the auto exposure bug.</li>
<li>Yep, that at least fixed the multiple defintion error!</li>
<li>[ ] Very curious to see if that fixes the autoexpose bug too!<ul>
<li>probably not, file size didn't change</li>
</ul>
</li>
<li>Also, not cleaning the build almost prevented me from catching this, SO! I am using make -B for now.</li>
<li>OK, cleaning done, tests are building, now I'm slowly bringing the tests back in.</li>
<li>[ ] Move <code>_AssertCall</code> into <b>mock-c</b><ul>
<li>defined in <code><a class="el" href="test__VisCmd_8c_source.html">test_VisCmd.c</a></code></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>How do I change the recipe for a target based on the top-level target (what make was invoked with, or the default if nothing was invoked)</p>
<p>Or, instead of doing that and mucking up my makefile, why not just throw the builds into different folders? Got myself a folder for test builds and a folder for AVR builds. Done.</p>
<p>Why was I passing in a map file to build the elf? No, this flag outputs a map file, and that's just for me to look at.</p>
<div class="fragment"><div class="line">-Wl,-Map=&quot;build/vis-spi-out.map&quot;</div>
</div><!-- fragment --><p>And why was I using &ndash;gc-sections?</p>
<p>This cuts the program size down from 25690 bytes to 17284 bytes</p>
<div class="fragment"><div class="line">-Wl,--gc-sections</div>
</div><!-- fragment --><p>This cuts the program size down from 17284 bytes to 8166 bytes </p><div class="fragment"><div class="line">-ffunction-sections -fdata-sections -fshort-enums</div>
</div><!-- fragment --><p>From the gcc documentation:</p>
<blockquote class="doxtable">
<p>-ffunction-sections -fdata-sections Place each function or data item into its own section in the output file if the target supports arbitrary sections. The name of the function or the name of the data item determines the section's name in the output file.</p>
<p>Use these options on systems where the linker can perform optimizations to improve locality of reference in the instruction space. Most systems using the ELF object format have linkers with such optimizations. On AIX, the linker rearranges sections (CSECTs) based on the call graph. The performance impact varies.</p>
<p>Together with a linker garbage collection (linker &ndash;gc-sections option) these options may lead to smaller statically-linked executables (after stripping). </p>
</blockquote>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
