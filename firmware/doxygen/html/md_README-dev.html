<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>firmware: User&#39;s Guide &ndash; setup Python API</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">firmware
   &#160;<span id="projectnumber">v0</span>
   </div>
   <div id="projectbrief">Protocol compatible with Python package microspeclib</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">User's Guide &ndash; setup Python API </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Sean is working on a <code>pip install</code> installation method. For now, here are the install steps without <code>pip install</code>.</p>
<h1>Install Python3.x</h1>
<p>Install Python3.7 or later.</p>
<h1>Clone <code>microspec</code></h1>
<p>Clone <code>microspec</code> in the <code>USERSITE</code> folder.</p>
<h2>Find <code>USERSITE</code> and make it if it does not exist</h2>
<p><code>pip install</code> sets up a package in the site-packages folder where Python looks for it. To use a package without <code>pip install</code>, I use the <code>USERSITE</code> folder.</p>
<p>Open PowerShell and check the value of USERSITE:</p>
<div class="fragment"><div class="line">&gt; python -m site --user-site</div>
<div class="line">C:\Users\mike\AppData\Roaming\Python\Python38\site-packages</div>
</div><!-- fragment --><p>The repo does not have to go in USERSITE, but it is a good default choice.</p>
<p>I do not install the repo here. For code-editing reasons, I prefer to install to the USERSITE for my Cygwin Python installation:</p>
<div class="fragment"><div class="line">$ python3.7 -m site --user-site</div>
<div class="line">/home/mike/.local/lib/python3.7/site-packages</div>
</div><!-- fragment --><p>I use Cygwin, but I run the Python applications using my Windows Python installation. The Windows Python installation is executed from Cygwin by specifying it at the bash command line as <code>python.exe</code>. The Windows Python installation searches the Cygwin Python USERSITE because I add this USERSITE path to the <code></p><dl class="section rcs"><dt>env</dt><dd>YTHONPATH in my PowerShell </dd></dl>
<p>PROFILE, as explained in below in <em>Edit the <code>PYTHONPATH</code></em>.</code></p>
<p><code>I can call <code>python.exe</code> from Windows or from Cygwin. It does not matter in this case. There are cases where attempting to run <code>python.exe</code> from Cygwin fails because of incompatiblity between Windows and POSIX path formatting.</code></p>
<p><code>I will continue to show examples from my actual setup below, where the <code>USERSITE</code> is in my Cygwin directory. The examples should work the same with any <code>USERSITE</code> path.</code></p>
<p><code>Create the <code>USERSITE</code> folder if it does not exist:</code></p>
<p><code></p><div class="fragment"><div class="line">&gt; mkdir -p C:\Users\mike\AppData\Roaming\Python\Python38\site-packages</div>
</div><!-- fragment --><p></code></p>
<p><code>Again, in my case I created this USERSITE folder instead:</code></p>
<p><code></p><div class="fragment"><div class="line">$ mkdir -p /home/mike/.local/lib/python3.7/site-packages</div>
</div><!-- fragment --><p></code></p>
<p><code></p><h2>Clone microspec in USERSITE</h2>
<p></code></p>
<p><code> Clone the repo there:</code></p>
<p><code></p><div class="fragment"><div class="line">$ cd /home/mike/.local/lib/python3.7/site-packages</div>
<div class="line">$ git clone https://github.com/microspectrometer/microspec</div>
</div><!-- fragment --><p></code></p>
<p><code></p><h2>Edit the <code>PYTHONPATH</code></h2>
<p></code></p>
<p><code> When looking for packages to import, Python uses the PYTHONPATH environment variable <em>if it exists</em>.</code></p>
<p><code>Since I am using the Windows Python installation, I create the PYTHONPATH environment variable using Windows conventions:</code></p>
<p><code></p><ul>
<li>backslashes</li>
<li>semicolons separate paths</li>
</ul>
<p></code></p>
<p><code>I add the following to my PowerShell profile:</code></p>
<p><code></p><div class="fragment"><div class="line">$pkg = &quot;C:\cygwin64\home\mike\.local\lib\python3.7\site-packages&quot;</div>
<div class="line">$env:PYTHONPATH = &quot;$pkg;&quot;</div>
<div class="line">$temp_api = &quot;microspec\src&quot;</div>
<div class="line">$env:PYTHONPATH += &quot;$pkg\$temp_api;&quot;</div>
</div><!-- fragment --><p></code></p>
<p><code>The trick here is that PowerShell runs the profile every time it starts. The profile creates the PYTHONPATH environment variable.</code></p>
<p><code>Check the <code>PYTHONPATH</code> in PowerShell:</code></p>
<p><code></p><div class="fragment"><div class="line">&gt; $env:PYTHONPATH.Split(&quot;;&quot;)</div>
<div class="line">C:\cygwin64\home\mike\.local\lib\python3.7\site-packages</div>
<div class="line">C:\cygwin64\home\mike\.local\lib\python3.7\site-packages\microspec\src</div>
</div><!-- fragment --><p></code></p>
<p><code>Packages in USERSITE import just fine without explicitly adding them to the PYTHONPATH. The issue with <code>microspec</code> is that the packages are not at the top-level.</code></p>
<p><code><code>microspec</code> contains more than just Python source code. The actual package for import is in the <code>src</code> folder. The other top-level folders contain executables and other things that Sean created. This is all temporary anyway, so just deal with the explicit path for now.</code></p>
<p><code></p><h1>Install Python package dependencies</h1>
<p></code></p>
<p><code></code></p>
<p><code></p><ul>
<li><code>python -m pip install pyserial</code></li>
<li><code>python -m pip install pytest</code></li>
<li><code>python -m pip install psutil</code></li>
<li><code>python -m pip install tabulate</code></li>
<li><code>python -m pip install sphinx</code></li>
<li><code>python -m pip install wheel</code> (I added this to Sean's list)</li>
<li><code>python -m pip install recommonmark</code></li>
<li><code>python -m pip install m2r</code></li>
<li><code>python -m pip install sphinxcontrib-argdoc</code></li>
</ul>
<p></code></p>
<p><code></p><h1>Check the installation</h1>
<p></code></p>
<p><code></code></p>
<p><code></p><div class="fragment"><div class="line">&gt; cd $pkg\microspec\</div>
<div class="line">&gt; pytest</div>
<div class="line">======================================================================== test session starts =========================================================================</div>
<div class="line">platform win32 -- Python 3.8.1, pytest-5.3.5, py-1.8.1, pluggy-0.13.1</div>
<div class="line">rootdir: C:\cygwin64\home\mike\.local\lib\python3.7\site-packages\microspec</div>
<div class="line">plugins: testdox-1.2.1</div>
<div class="line">collected 147 items</div>
<div class="line"> </div>
<div class="line">tests\test_bytesio_stream.py ..................                                                                                                                 [ 12%]</div>
<div class="line">tests\test_emulated_stream.py ..................ssssssssssssssssssss                                                                                            [ 38%]</div>
<div class="line">tests\test_emulator.py ..........                                                                                                                               [ 44%]</div>
<div class="line">tests\test_expert_interface_emulator.py ssssssssss                                                                                                              [ 51%]</div>
<div class="line">tests\test_expert_interface_hardware.py xxxxxxxxxx                                                                                                              [ 58%]</div>
<div class="line">tests\test_json.py ....                                                                                                                                         [ 61%]</div>
<div class="line">tests\test_payload.py ..................................                                                                                                        [ 84%]</div>
<div class="line">tests\test_simple_interface_emulator.py ssssssssss                                                                                                              [ 91%]</div>
<div class="line">tests\test_simple_interface_hardware.py xxxxxxxxxx                                                                                                              [ 97%]</div>
<div class="line">tests\test_util.py ...                                                                                                                                          [100%]</div>
<div class="line"> </div>
<div class="line">============================================================= 87 passed, 40 skipped, 20 xfailed in 1.24s =============================================================</div>
</div><!-- fragment --><p></code></p>
<p><code>Expect the same result (87 passed, 40 skipped, 20 xfailed) when running from Cygwin bash. The 20 xfailed tests are <code>expected fail</code> meaning the test suite knows to expect the tests to fail because the hardware is not connected.</code></p>
<p><code></p><h1>Documentation</h1>
<p></code></p>
<p><code></code></p>
<p><code></p><h2>Ways to access documentation</h2>
<p></code></p>
<p><code></code></p>
<p><code>Read with <code>pydoc</code>:</code></p>
<p><code></p><div class="fragment"><div class="line">&gt; python -m pydoc microspeclib</div>
<div class="line">&gt; python -m pydoc microspeclib.simple</div>
<div class="line">&gt; python -m pydoc microspeclib.expert</div>
</div><!-- fragment --><p></code></p>
<p><code>Read the expert interface:</code></p>
<p><code></p><div class="fragment"><div class="line">&gt; python -m pydoc microspeclib.expert.MicroSpecExpertInterface</div>
<div class="line">Help on class MicroSpecExpertInterface in microspeclib.expert:</div>
</div><!-- fragment --><p></code></p>
<p><code>Read the HTML:</code></p>
<p><code></p><div class="fragment"><div class="line">&gt; cd $pkg\microspec\doc\build\html\</div>
<div class="line">&gt; explorer index.html</div>
</div><!-- fragment --><p></code></p>
<p><code>The API is buried here in the HTML:</code></p>
<p><code></p><div class="fragment"><div class="line">&gt; cd $pkg\microspec\doc\build\html\</div>
<div class="line">&gt; explorer microspeclib.simple.html</div>
</div><!-- fragment --><p></code></p>
<p><code>I made a Vim shortcut to open this section in the browser:</code></p>
<p><code></p><div class="fragment"><div class="line">;api</div>
</div><!-- fragment --><p></code></p>
<p><code>Get help on a specific API command with pydoc.</code></p>
<p><code>Example: help on <b>GetExposure</b></code></p>
<p><code>```powershell </p><blockquote class="doxtable">
<p>python -m pydoc microspeclib.simple.MicroSpecSimpleInterface.getExposure </p>
</blockquote>
<p></code></p>
<p><code>Help on function func in microspeclib.simple.MicroSpecSimpleInterface:</code></p>
<p><code>microspeclib.simple.MicroSpecSimpleInterface.getExposure = func(self, **kwargs) Retrieve the current exposure setting, which may have been set either by :class:<code>~microspeclib.datatypes.command.CommandSetExposure</code> or :class:<code>~microspeclib.datatypes.command.CommandAutoExposure</code>.</code></p>
<p><code></p><h1>Returns </h1>
<p></code></p>
<p><code> :class:<code>~microspeclib.datatypes.bridge.BridgeGetExposure</code> :class:<code>~microspeclib.datatypes.sensor.SensorGetExposure</code> </p><div class="fragment"><div class="line">The *useful* help is in the return value. Look at the</div>
<div class="line">`microspeclib.datatypes.sensor` return bytes.</div>
<div class="line"> </div>
<div class="line">```powershell</div>
<div class="line">&gt; python -m pydoc microspeclib.datatypes.sensor.SensorGetExposure</div>
</div><!-- fragment --><p></code></p>
<p><code>The names of the variables in the reply are listed in the <b>keyword arguments</b>:</code></p>
<p><code></p><div class="fragment"><div class="line">Help on class SensorGetExposure in microspeclib.datatypes.sensor:</div>
<div class="line"> </div>
<div class="line">microspeclib.datatypes.sensor.SensorGetExposure = class SensorGetExposure(MicroSpecPayload)</div>
<div class="line"> |  microspeclib.datatypes.sensor.SensorGetExposure(*args, status=None, cycles=None, **kwargs)</div>
<div class="line"> |  </div>
<div class="line"> ...</div>
</div><!-- fragment --><p></code></p>
<p><code>And in the description of the <b>kwargs</b> under under <code>Parameters</code>:</code></p>
<p><code></p><div class="fragment"><div class="line">...</div>
<div class="line">|  Parameters</div>
<div class="line">|  ----------</div>
<div class="line">|  status: :data:`~microspeclib.datatypes.types.StatusOK` or :data:`~microspeclib.datatypes.types.StatusError`  If there is an error status, the other attributes are not valid</div>
<div class="line">|  cycles: 1-65535</div>
<div class="line">|    Number of cycles to wait to collect pixel strength.</div>
<div class="line">...</div>
</div><!-- fragment --><p></code></p>
<p><code></p><h2>Return values in the API</h2>
<p></code></p>
<p><code></code></p>
<p><code>There are always bytes returned from both boards:</code></p>
<p><code></p><ul>
<li>the <b>Sensor</b> board (<code>vis-spi-out</code>)</li>
<li>the <b>Bridge</b> board (<code>usb-bridge</code>)</li>
</ul>
<p></code></p>
<p><code>Few commands are for the Bridge. The Bridge is meant to be transparent. Exceptions are GetBridgeLED, SetBridgeLED, and Reset.</code></p>
<p><code>For all other commands, the <b>Sensor</b> return bytes are all that matters. In fact, the simple interface hides the <b>Bridge</b> return bytes for these commands.</code></p>
<p><code>Takeaway: to find out what response a command gives, get help on the command to find out what the name of the return type is, then get help on the <b>Sensor</b> return type.</code></p>
<p><code>The <b>Bridge</b> is a buffer between the <b>Sensor</b> board and whatever serial communication plumbing the application uses to talk to the <b>Sensor</b> board. The dev-kit, for example, provides a USB bridge. Drop in another bridge, say a bluetooth bridge, and as long as it complies with the <code>bridge</code> section of the JSON protocol, the Python API works exactly the same.</code></p>
<p><code></p><h1>Extend the API</h1>
<p></code></p>
<p><code></code></p>
<p><code>It is easy to extend the API to work with custom firmware.</code></p>
<p><code>Example: extend the API to make the AutoExpose configurable</code></p>
<p><code>Add commands:</code></p>
<p><code></p><ul>
<li>GetAutoExposeConfig</li>
<li>SetAutoExposeConfig</li>
</ul>
<p></code></p>
<p><code>GetAutoExposeConfig sends one byte:</code></p>
<p><code></p><ul>
<li><code>command_id</code></li>
</ul>
<p></code></p>
<p><code>Expect one byte from the <b>Bridge</b>:</code></p>
<p><code></p><ul>
<li><code>status</code></li>
</ul>
<p></code></p>
<p><code>Expect ten bytes from the <b>Sensor</b>:</code></p>
<p><code></p><ul>
<li><code>status</code> (1 byte)</li>
<li><code>max_tries</code> (1 byte)</li>
<li><code>start_pixel</code> (2 bytes)</li>
<li><code>stop_pixel</code> (2 bytes)</li>
<li><code>target</code> (2 bytes)</li>
<li><code>target_tolerance</code> (2 bytes)</li>
</ul>
<p></code></p>
<p><code>SetAutoExposeConfig sends ten bytes:</code></p>
<p><code></p><ul>
<li><code>command_id</code> (1 byte)</li>
<li><code>max_tries</code> (1 byte)</li>
<li><code>start_pixel</code> (2 bytes)</li>
<li><code>stop_pixel</code> (2 bytes)</li>
<li><code>target</code> (2 bytes)</li>
<li><code>target_tolerance</code> (2 bytes)</li>
</ul>
<p></code></p>
<p><code>Expect one byte from the <b>Bridge</b>:</code></p>
<p><code></p><ul>
<li><code>status</code></li>
</ul>
<p></code></p>
<p><code>Expect one byte from the <b>Sensor</b>:</code></p>
<p><code></p><ul>
<li><code>status</code></li>
</ul>
<p></code></p>
<p><code></p><h2>Edit JSON</h2>
<p></code></p>
<p><code></code></p>
<p><code>Encode this in the JSON file in the three sections, <code>command</code>, <code>bridge</code>, and <code>sensor</code>.</code></p>
<p><code>Under section <code>command</code>:</code></p>
<p><code></p><div class="fragment"><div class="line">...</div>
<div class="line">,&quot;13&quot;: { &quot;name&quot;: &quot;GetAutoExposeConfig&quot;, &quot;variables&quot;: [ &quot;command_id&quot; ], &quot;sizes&quot;: [1] }</div>
<div class="line">,&quot;14&quot;: { &quot;name&quot;: &quot;SetAutoExposeConfig&quot;, &quot;variables&quot;: [ &quot;command_id&quot;, &quot;max_tries&quot;, &quot;start_pixel&quot;, &quot;stop_pixel&quot;, &quot;target&quot;, &quot;target_tolerance&quot; ], &quot;sizes&quot;: [1,1,2,2,2,2] }</div>
</div><!-- fragment --><p></code></p>
<p><code>Under section <code>bridge</code>:</code></p>
<p><code></p><div class="fragment"><div class="line">...</div>
<div class="line">,&quot;13&quot;: { &quot;name&quot;: &quot;GetAutoExposeConfig&quot;, &quot;variables&quot;: [ &quot;status&quot; ], &quot;sizes&quot;: [1] }</div>
<div class="line">,&quot;14&quot;: { &quot;name&quot;: &quot;SetAutoExposeConfig&quot;, &quot;variables&quot;: [ &quot;status&quot; ], &quot;sizes&quot;: [1] }</div>
</div><!-- fragment --><p></code></p>
<p><code>Under section <code>sensor</code>:</code></p>
<p><code></p><div class="fragment"><div class="line">...</div>
<div class="line">,&quot;13&quot;: { &quot;name&quot;: &quot;GetAutoExposeConfig&quot;, &quot;variables&quot;: [ &quot;status&quot;, &quot;max_tries&quot;, &quot;start_pixel&quot;, &quot;stop_pixel&quot;, &quot;target&quot;, &quot;target_tolerance&quot; ], &quot;sizes&quot;: [1,1,2,2,2,2] }</div>
<div class="line">,&quot;14&quot;: { &quot;name&quot;: &quot;SetAutoExposeConfig&quot;, &quot;variables&quot;: [ &quot;status&quot; ], &quot;sizes&quot;: [1] }</div>
</div><!-- fragment --><p></code></p>
<p><code></p><h2>Test at the REPL</h2>
<p></code></p>
<p><code></code></p>
<p><code>Try auto-complete at the REPL to test the commands are added to the API:</code></p>
<p><code></p><div class="fragment"><div class="line">&gt;&gt;&gt; from microspeclib.simple import MicroSpecSimpleInterface</div>
<div class="line">&gt;&gt;&gt; si = MicroSpecSimpleInterface()</div>
<div class="line">&gt;&gt;&gt; si.getA&lt;TAB&gt;</div>
</div><!-- fragment --><p></code></p>
<p><code>Pressing TAB, that last line auto-completes:</code></p>
<p><code></p><div class="fragment"><div class="line">&gt;&gt;&gt; si.getAutoExposeConfig</div>
</div><!-- fragment --><p></code></p>
<p><code>Similarly:</code></p>
<p><code></p><div class="fragment"><div class="line">&gt;&gt;&gt; si.setA&lt;TAB&gt;</div>
</div><!-- fragment --><p></code></p>
<p><code>Pressing TAB, auto-complete yields:</code></p>
<p><code></p><div class="fragment"><div class="line">&gt;&gt;&gt; si.setAutoExposeConfig</div>
</div><!-- fragment --><p></code></p>
<p><code></p><h2>Edit the documentation</h2>
<p></code></p>
<p><code></code></p>
<p><code>Merely editing the JSON file provides default documentation that shows the function signature. If the command takes parameters, these are listed in the function signature.</code></p>
<p><code></p><div class="fragment"><div class="line">$ python.exe -m pydoc microspeclib.simple.MicroSpecSimpleInterface.setAutoExposeConfig</div>
<div class="line"> </div>
<div class="line">Help on function func in microspeclib.simple.MicroSpecSimpleInterface:</div>
<div class="line"> </div>
<div class="line">microspeclib.simple.MicroSpecSimpleInterface.setAutoExposeConfig = func(self, max_tries=None, start_pixel=None, stop_pixel=None, target=None, target_tolerance=None, **kwargs)</div>
</div><!-- fragment --><p></code></p>
<p><code>This at least indicates the names of the expected parameters, and then the developer can look up the sizes in the JSON file.</code></p>
<p><code>But it is better to add a docstring and a description of each parameter.</code></p>
<p><code>Add docstrings to <code>/internal/docstrings.py</code>:</code></p>
<p><code>```python</code></p>
<p><code>MICROSPEC_DYNAMIC_DOC["command"]["CommandGetAutoExposeConfig"] = """Retrieves the current auto-expose configuration.</code></p>
<p><code></p><h1>Returns </h1>
<p></code></p>
<p><code> :class:<code>~{dt}.bridge.BridgeGetAutoExposeConfig</code> :class:<code>~{dt}.sensor.SensorGetAutoExposeConfig</code></code></p>
<p><code>""" ```</code></p>
<p><code>Now the help contains the docstring and lists the return types.</code></p>
<p><code>```bash $ python.exe -m pydoc microspeclib.simple.MicroSpecSimpleInterface.getAutoExposeConfig</code></p>
<p><code>Help on function func in microspeclib.simple.MicroSpecSimpleInterface:</code></p>
<p><code>microspeclib.simple.MicroSpecSimpleInterface.getAutoExposeConfig = func(self, **kwargs) Retrieves the current auto-expose configuration.</code></p>
<p><code></p><h1>Returns </h1>
<p></code></p>
<p><code> :class:<code>~microspeclib.datatypes.bridge.BridgeGetAutoExposeConfig</code> :class:<code>~microspeclib.datatypes.sensor.SensorGetAutoExposeConfig</code> ```</code></p>
<p><code>The docstring for <code>setAutoExposeConfig</code> is much longer because it contains parameters.</code></p>
<p><code>```python MICROSPEC_DYNAMIC_DOC["command"]["CommandSetAutoExposeConfig"] = """Sets the current auto-expose configuration.</code></p>
<p><code></p><h1>Parameters </h1>
<p></code></p>
<p><code> max_tries: 1-255 Maximum number of exposures to try before giving up.</code></p>
<p><code> Firmware defaults to 10 on power-up.</code></p>
<p><code>start_pixel: 7-392 if binning on, 14-784 if binning off Auto-expose ignores pixels below start_pixel when checking if the peak is in the target range.</code></p>
<p><code> Firmware defaults to 7 on power-up. Recommended value is the smallest pixel number in the pixel-to-wavelength map.</code></p>
<p><code> If start_pixel is outside the allowed range, status is ERROR and the AutoExposeConfig is not changed.</code></p>
<p><code>stop_pixel: 7-392 if binning on, 14-784 if binning off, must be &gt;= start_pixel Auto-expose ignores pixels above stop_pixel when checking if the peak is in the target range.</code></p>
<p><code> Firmware defaults to 392 on power-up. Recommended value is the largest pixel number in the pixel-to-wavelength map.</code></p>
<p><code> If stop_pixel &lt; start_pixel, or if stop_pixel is outside the allowed range, status is ERROR and the AutoExposeConfig is not changed.</code></p>
<p><code>target: 4500-65535 Target peak-counts for exposure gain calculation.</code></p>
<p><code> Firmware defaults to 46420 counts on power-up.</code></p>
<p><code> If target is outside the allowed range, status is ERROR and the AutoExposeConfig is not changed.</code></p>
<p><code>target_tolerance: 0-65535 target +/- target_tolerance is the target peak-counts range. Auto-expose is finished when the peak counts lands in this range.</code></p>
<p><code> Firmware defaults to 3277 counts on power-up.</code></p>
<p><code> If the combination of target and target_tolerance results in target ranges extending below 4500 counts or above 65535 counts, auto-expose ignores the target_tolerance and clamps the target range at these boundaries.</code></p>
<p><code></p><h1>Returns </h1>
<p></code></p>
<p><code> :class:<code>~{dt}.bridge.BridgeSetAutoExposeConfig</code> :class:<code>~{dt}.sensor.SensorSetAutoExposeConfig</code></code></p>
<p><code>""" </p><div class="fragment"><div class="line">Here is the resulting help for `setAutoExposeConfig`:</div>
</div><!-- fragment --><p></code></p>
<p><code>$ python.exe -m pydoc microspeclib.simple.MicroSpecSimpleInterface.setAutoExposeConfig</code></p>
<p><code>Help on function func in microspeclib.simple.MicroSpecSimpleInterface:</code></p>
<p><code>microspeclib.simple.MicroSpecSimpleInterface.setAutoExposeConfig = func(self, max_tries=None, start_pixel=None, stop_pixel=None, target=None, target_tolerance=None, **kwargs) Sets the current auto-expose configuration.</code></p>
<p><code></p><h1>Parameters </h1>
<p></code></p>
<p><code> max_tries: 1-255 Maximum number of exposures to try before giving up.</code></p>
<p><code> Firmware defaults to 10 on power-up.</code></p>
<p><code> start_pixel: 7-392 if binning on, 14-784 if binning off Auto-expose ignores pixels below start_pixel when checking if the peak is in the target range.</code></p>
<p><code> Firmware defaults to 7 on power-up. Recommended value is the smallest pixel number in the pixel-to-wavelength map.</code></p>
<p><code> If start_pixel is outside the allowed range, status is ERROR and the AutoExposeConfig is not changed.</code></p>
<p><code> stop_pixel: 7-392 if binning on, 14-784 if binning off, must be &gt;= start_pixel Auto-expose ignores pixels above stop_pixel when checking if the peak is in the target range.</code></p>
<p><code> Firmware defaults to 392 on power-up. Recommended value is the largest pixel number in the pixel-to-wavelength map.</code></p>
<p><code> If stop_pixel &lt; start_pixel, or if stop_pixel is outside the allowed range, status is ERROR and the AutoExposeConfig is not changed.</code></p>
<p><code> target: 4500-65535 Target peak-counts for exposure gain calculation.</code></p>
<p><code> Firmware defaults to 46420 counts on power-up.</code></p>
<p><code> If target is outside the allowed range, status is ERROR and the AutoExposeConfig is not changed.</code></p>
<p><code> target_tolerance: 0-65535 target +/- target_tolerance is the target peak-counts range. Auto-expose is finished when the peak counts lands in this range.</code></p>
<p><code> Firmware defaults to 3277 counts on power-up.</code></p>
<p><code> If the combination of target and target_tolerance results in target ranges extending below 4500 counts or above 65535 counts, auto-expose ignores the target_tolerance and clamps the target range at these boundaries.</code></p>
<p><code></p><h1>Returns </h1>
<p></code></p>
<p><code> :class:<code>~microspeclib.datatypes.bridge.BridgeSetAutoExposeConfig</code> :class:<code>~microspeclib.datatypes.sensor.SensorSetAutoExposeConfig</code> </p><div class="fragment"><div class="line">For the `getAutoExposeConfig` command, the useful help is in the</div>
<div class="line">keyword arguments of the **Sensor** return type.</div>
<div class="line"> </div>
<div class="line">```bash</div>
<div class="line">$ python.exe -m pydoc microspeclib.datatypes.sensor.SensorSetAutoExposeConfig</div>
</div><!-- fragment --><p></code></p>
<p><code>Again, all of the following is done automatically merely by encoding the command in the JSON file.</code></p>
<p><code>The reply's variable names are listed in the keyword arguments of the datatype <code>__init__()</code> method:</code></p>
<p><code></p><div class="fragment"><div class="line">Help on class SensorGetAutoExposeConfig in microspeclib.datatypes.sensor:</div>
<div class="line"> </div>
<div class="line">microspeclib.datatypes.sensor.SensorGetAutoExposeConfig = class SensorGetAutoExposeConfig(MicroSpecPayload)</div>
<div class="line"> |  microspeclib.datatypes.sensor.SensorGetAutoExposeConfig(*args, status=None, max_tries=None, start_pixel=None, stop_pixel=None, target=None, target_tolerance=None, **kwargs)</div>
<div class="line"> ...</div>
</div><!-- fragment --><p></code></p>
<p><code>The <code>command_id</code> is listed:</code></p>
<p><code></p><div class="fragment"><div class="line">...</div>
<div class="line">|  Data and other attributes defined here:</div>
<div class="line">|  </div>
<div class="line">|  command_id = 13</div>
<div class="line">...</div>
</div><!-- fragment --><p></code></p>
<p><code>The size of each response is listed:</code></p>
<p><code></p><div class="fragment"><div class="line">...</div>
<div class="line">|  Data and other attributes defined here:</div>
<div class="line">...</div>
<div class="line">|  sizes = [1, 1, 2, 2, 2, 2]</div>
<div class="line">...</div>
<div class="line">|  variables = [&#39;status&#39;, &#39;max_tries&#39;, &#39;start_pixel&#39;, &#39;stop_pixel&#39;, &#39;targ...</div>
<div class="line">...</div>
</div><!-- fragment --><p></code></p>
<p><code></p><h2>Rebuild the Sphinx documentation</h2>
<p></code></p>
<p><code></p><ul>
<li>[ ] learn how to do this, I've made many changes and I want to see what impact newlines have on the Sphinx output</li>
</ul>
<p></code></p>
<p><code></p><h1>Load VCP</h1>
<p></code></p>
<p><code></code></p>
<p><code></p><ul>
<li>On Windows, sometimes VCP is not set. Go to Device Manager:<ul>
<li>Right-click on USB Serial Converter</li>
<li>Select Properties</li>
<li>Go to tab "Advanced"</li>
<li>Check "Load VCP"</li>
</ul>
</li>
</ul>
<p></code></p>
<p><code>I tried to automate this in the FTDI EEPROM.</code></p>
<p><code></p><ul>
<li>under <code>Hardware Specific</code>, <code>Port A</code>, <code>Driver</code></li>
<li>change <code>D2XX Direct</code> to <code>Virtual COM Port</code></li>
</ul>
<p></code></p>
<p><code>This did not work. The device is still not visible to pyserial.</code></p>
<p><code></p><h1>Quick script to test VCP</h1>
<p></code></p>
<p><code></code></p>
<p><code>Make a quick test script to check that the hardware is visible:</code></p>
<p><code><code>test-hardware-is-visible.py</code>:</code></p>
<p><code></p><div class="fragment"><div class="line">&#39;&#39;&#39;Test hardware is visible.&#39;&#39;&#39;</div>
<div class="line"> </div>
<div class="line">from microspeclib.simple import MicroSpecSimpleInterface</div>
<div class="line">si = MicroSpecSimpleInterface(timeout=0.1)</div>
<div class="line">print(si)</div>
</div><!-- fragment --><p></code></p>
<p><code></p><div class="fragment"><div class="line">&gt; python test-hardware-is-visible.py</div>
<div class="line">&lt;microspeclib.simple.MicroSpecSimpleInterface object at 0x000001B5F0AB42B0&gt;</div>
</div><!-- fragment --><p></code></p>
<p><code>If the dev-kit is not connected or VCP is not enabled, this test produces error <code>Cannot find CHROMATION device</code>:</code></p>
<p><code></p><div class="fragment"><div class="line">&gt; python test-hardware-is-visible.py</div>
<div class="line">2020-04-28 22:20:37,772:stream.py:__init__:193: Cannot find CHROMATION device</div>
<div class="line">Traceback (most recent call last):</div>
<div class="line">  File &quot;C:\cygwin64\home\mike\chromation\dev-kit-mike\firmware\python\test.py&quot;, line 6, in &lt;module&gt;</div>
<div class="line">    si = MicroSpecSimpleInterface(timeout=0.1)</div>
<div class="line">  File &quot;C:\cygwin64\home\mike\.local\lib\python3.7\site-packages\microspec\src\microspeclib\expert.py&quot;, line 24, in __init__</div>
<div class="line">    super().__init__(serial_number=serial_number,</div>
<div class="line">  File &quot;C:\cygwin64\home\mike\.local\lib\python3.7\site-packages\microspec\src\microspeclib\internal\stream.py&quot;, line 194, in __init__</div>
<div class="line">    raise MicroSpecConnectionException(&quot;Cannot find CHROMATION device&quot;)</div>
<div class="line">microspeclib.exceptions.MicroSpecConnectionException: Cannot find CHROMATION device</div>
</div><!-- fragment --><p></code></p>
<p><code></p><h1>User's Guide &ndash; use Python API</h1>
<p></code></p>
<p><code> As of May 2020: I've just started using the Python API. Sean's <code>cmdline.py</code> utility lets me send any single API command and look at the response. This is very convenient. I am just doing quick system tests, so I have no reason to write my own scripts at this point. The <code>cmdline.py</code> utility does everything I need.</code></p>
<p><code>See section <code>system test from the command line</code> below.</code></p>
<p><code></p><h1>Developer's Guide &ndash; feedback on Sean's API</h1>
<p></code></p>
<p><code></code></p>
<p><code></p><h2>Show signature does not work in ptpython</h2>
<p></code></p>
<p><code></code></p>
<p><code>Jonathan Slenders ptpython makes it easy to discover how to use a package at the command line. Tab-complete to get a list of attributes and methods, and then once one is chosen, he uses Jedi to show the function signature.</code></p>
<p><code>PyPi page: <a href="https://pypi.org/project/jedi/">https://pypi.org/project/jedi/</a></code></p>
<p><code>Jedi is meant for adding Python auto-complete to IDEs. Vim example: <a href="https://github.com/davidhalter/jedi-vim">https://github.com/davidhalter/jedi-vim</a></code></p>
<p><code>The way Sean set up the docstrings, Jedi's <code>get_signatures</code> (method for reading function signatures) is broken.</code></p>
<p><code><a href="https://jedi.readthedocs.io/en/latest/docs/api.html#jedi.Script.get_signatures">https://jedi.readthedocs.io/en/latest/docs/api.html#jedi.Script.get_signatures</a></code></p>
<p><code>From Sean's <code>docstring</code> module:</code></p>
<p><code></p><blockquote class="doxtable">
<p>Great pains were taken to auto-generate the proper function and class signatures such as <code>CommandSetBridgeLED(led_num=None, led_setting=None)</code> rather than just <code>CommandSetBridgeLED(\*args, \**kwargs)</code>, so that pydoc and sphinx could introspect and document them properly. </p>
</blockquote>
<p></code></p>
<p><code>Thus Sean generates a single source of truth for code and documentation. The tradeoff for this is that Jedi cannot find the docstrings.</code></p>
<p><code>The workaround to this minor inconvenience is to explicitly call help. So, tab-complete as usual to get the method name, then instead of opening parentheses to see the docstring, wrap the method in help, e.g., <code>help(si.getBridgeLED)</code>, and hit Enter to read the docstring.</code></p>
<p><code></p><h2>Notes on these notes</h2>
<p></code></p>
<p><code> From hereon, I refer to paths in Sean's repo with <code>.</code> meaning the repo name.</code></p>
<p><code>Capitalization does not matter, but I capitalize (contrary to the documentation examples) to match with <code>./cfg/microspec.json</code>. Sean asked for feedback on the API in the microspeclib package and the supporting utilities and documentation. I am using the API to write system tests as I develop the firmware.</code></p>
<p><code></p><h2>I dogfood Sean's API by doing system tests</h2>
<p></code></p>
<p><code></code></p>
<p><code>I am using the command line utilities as a convenience for quick system testing, i.e., testing that is not code, just me trying something at the command line to check that firmware changes have the expected result.</code></p>
<p><code>I system test as I code the firmware to point me in the right direction <em>before</em> I spend time programming system tests.</code></p>
<p><code></p><h1>Developer's Guide &ndash; system test from the command line</h1>
<p></code></p>
<p><code></code></p>
<p><code></p><div class="fragment"><div class="line">python.exe -m cmdline COMMAND KEY=VALUE</div>
</div><!-- fragment --><p></code></p>
<p><code>I made Vim shortcuts start with <code>pt</code> (pneumonic is <code>p</code>ython <code>t</code>est):</code></p>
<p><code></p><div class="fragment"><div class="line">nnoremap &lt;leader&gt;pt&lt;Space&gt; :!python.exe -m cmdline </div>
<div class="line">nnoremap &lt;leader&gt;pt0 :!python.exe -m cmdline Null</div>
<div class="line">nnoremap &lt;leader&gt;pt1 :!python.exe -m cmdline GetBridgeLED led_num=0</div>
<div class="line">nnoremap &lt;leader&gt;pt2 :!python.exe -m cmdline SetBridgeLED led_num=255 led_setting=255</div>
</div><!-- fragment --><p></code></p>
<p><code></p><h2>System test examples from the command line</h2>
<p></code></p>
<p><code> My examples work from PowerShell and Cygwin bash.</code></p>
<p><code></p><h3>Finding bugs on 2020-04-28</h3>
<p></code></p>
<p><code></code></p>
<p><code>This opens communication:</code></p>
<p><code></p><div class="fragment"><div class="line">si = MicroSpecSimpleInterface()</div>
</div><!-- fragment --><p></code></p>
<p><code>But this throws an error:</code></p>
<p><code></p><div class="fragment"><div class="line">si = MicroSpecSimpleInterface(serial_number=&#39;CHROMATION091103&#39;)</div>
</div><!-- fragment --><p></code></p>
<p><code>Error traces back to line 177 of internal/stream.py:</code></p>
<p><code></p><div class="fragment"><div class="line">self.serial.port = list_ports.grep(serial_number).device</div>
</div><!-- fragment --><p></code></p>
<p><code>Full error message:</code></p>
<p><code></p><div class="fragment"><div class="line">  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</div>
<div class="line">  File &quot;C:\cygwin64\home\mike\.local\lib\python3.7\site-packages\microspec\src\microspeclib\expert.py&quot;, line 24, in __init__</div>
<div class="line">    super().__init__(serial_number=serial_number,</div>
<div class="line">  File &quot;C:\cygwin64\home\mike\.local\lib\python3.7\site-packages\microspec\src\microspeclib\internal\stream.py&quot;, line 177, in __init__</div>
<div class="line">    self.serial.port = list_ports.grep(serial_number).device</div>
<div class="line">AttributeError: &#39;generator&#39; object has no attribute &#39;device&#39;</div>
<div class="line"> </div>
<div class="line">&#39;generator&#39; object has no attribute &#39;device&#39;</div>
</div><!-- fragment --><p></code></p>
<p><code>Did Sean mean this?</code></p>
<p><code></p><div class="fragment"><div class="line">from serial.tools import list_ports</div>
<div class="line">next(list_ports.grep(&#39;CHROMATION091103&#39;)).device</div>
</div><!-- fragment --><p></code></p>
<p><code>Or this?</code></p>
<p><code></p><div class="fragment"><div class="line">from serial.tools import list_ports</div>
<div class="line">list(list_ports.grep(&#39;CHROMATION091103&#39;))[0].device</div>
</div><!-- fragment --><p></code></p>
<p><code></p><h3>Hello world between API and <code>usb-bridge</code></h3>
<p></code></p>
<p><code></code></p>
<p><code>Here is the loop on <code>usb-bridge</code>:</code></p>
<p><code></p><div class="fragment"><div class="line"><span class="keywordtype">void</span> loop(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">while</span> (<a class="code" href="Usb_8h.html#a3081311c24ae86b950d6770c6a67cedb">UsbRxbufferIsEmpty</a>()); <span class="comment">// loop until cmd received</span></div>
<div class="line">    uint8_t <a class="code" href="Cmd_8h.html#ad48b407655ab242ef8b80e5ad0084399">cmd</a> = 0; <span class="comment">// initialize cmd as &quot;Null&quot;</span></div>
<div class="line">    <a class="code" href="Usb_8h.html#a4ed6f08cb0ec2adf9631d0932b30bbc5">UsbReadByte</a>(&amp;<a class="code" href="Cmd_8h.html#ad48b407655ab242ef8b80e5ad0084399">cmd</a>); <span class="comment">// read cmd</span></div>
<div class="line">    <span class="keywordflow">switch</span>(<a class="code" href="Cmd_8h.html#ad48b407655ab242ef8b80e5ad0084399">cmd</a>) <span class="comment">// look up cmd</span></div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">case</span> 0: <a class="code" href="UsbCmd_8h.html#ac2b6a4bbe89e22076102bc8a65c69ecd">NullCommand</a>(); <a class="code" href="BiColorLed_8h.html#a2401f7a281e7e5cbc5c76c074cf7fe6b">BiColorLedGreen</a>(status_led); <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">default</span>: <a class="code" href="BiColorLed_8h.html#a2da32b453449ba56817344847d923a93">BiColorLedRed</a>(status_led); <span class="keywordflow">break</span>;  <span class="comment">// sbi  0x08, 3</span></div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p></code></p>
<p><code>Here is the command line:</code></p>
<p><code></p><div class="fragment"><div class="line">PS C:\Users\mike&gt; python -m cmdline Null</div>
<div class="line">2020-04-29T18:34:46.495822,BridgeNull()</div>
<div class="line"> </div>
<div class="line">PS C:\Users\mike&gt; python -m cmdline GetBridgeLed led_num=1</div>
<div class="line">2020-04-29T18:34:57.172661,None</div>
<div class="line"> </div>
<div class="line">PS C:\Users\mike&gt; python -m cmdline Null</div>
<div class="line">2020-04-29T18:35:01.499843,BridgeNull()</div>
</div><!-- fragment --><p></code></p>
<p><code>Behavior is good:</code></p>
<p><code></p><ul>
<li><b>PASS</b>: the PCB powers up with its LED green</li>
<li><b>PASS</b>: the first Null has no obvious effect</li>
<li>the second command, GetBridgeLED led_num=1, sends bytes 0x01 0x01</li>
<li>this simplistic loop() should see these as two commands with byte value 0x01</li>
<li>so both 0x01 <em>should go to the default case: turn the LED red</em></li>
<li><b>PASS</b>: the LED turns red</li>
<li><em>sending the final Null should turn the LED back to green</em></li>
<li><b>PASS</b>: the LED turns green</li>
</ul>
<p></code></p>
<p><code>If I have no better use for the LED, it can indicate whether the most recent command was recognized.</code></p>
<p><code></p><h3>system test GetBridgeLED</h3>
<p></code></p>
<p><code></code></p>
<p><code>GetBridgeLED gets <code>led_setting=1</code> and <code>led_setting=2</code></code></p>
<p><code></p><ul>
<li><code>led_setting=1</code> means <em>Status LED is GREEN</em></li>
<li><code>led_setting=2</code> means <em>Status LED is RED</em></li>
</ul>
<p></code></p>
<p><code>Here is the <code>main()</code> loop when I ran this system test:</code></p>
<p><code></p><div class="fragment"><div class="line"><span class="keywordtype">void</span> loop(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">while</span> (<a class="code" href="Usb_8h.html#a3081311c24ae86b950d6770c6a67cedb">UsbRxbufferIsEmpty</a>()); <span class="comment">// loop until cmd received</span></div>
<div class="line">    uint8_t <a class="code" href="Cmd_8h.html#ad48b407655ab242ef8b80e5ad0084399">cmd</a> = 0; <span class="comment">// initialize cmd as &quot;Null&quot;</span></div>
<div class="line">    <a class="code" href="Usb_8h.html#a4ed6f08cb0ec2adf9631d0932b30bbc5">UsbReadByte</a>(&amp;<a class="code" href="Cmd_8h.html#ad48b407655ab242ef8b80e5ad0084399">cmd</a>); <span class="comment">// read cmd</span></div>
<div class="line">    <span class="keywordflow">switch</span>(<a class="code" href="Cmd_8h.html#ad48b407655ab242ef8b80e5ad0084399">cmd</a>) <span class="comment">// look up cmd</span></div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Turn status LED red if cmd is not recognized.</span></div>
<div class="line">        <span class="keywordflow">default</span>:                    <a class="code" href="BiColorLed_8h.html#a2da32b453449ba56817344847d923a93">BiColorLedRed</a>(status_led);   <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="comment">// Null gets no response, but turns status LED green for now.</span></div>
<div class="line">        <span class="keywordflow">case</span> 0: <a class="code" href="UsbCmd_8h.html#ac2b6a4bbe89e22076102bc8a65c69ecd">NullCommand</a>();      <a class="code" href="BiColorLed_8h.html#a2401f7a281e7e5cbc5c76c074cf7fe6b">BiColorLedGreen</a>(status_led); <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> 1: <a class="code" href="UsbCmd_8h.html#a2be59832e776d1ef15b9d995e18cf26d">GetBridgeLED</a>(); <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p></code></p>
<p><code>And here is the system test.</code></p>
<p><code>START: power-on, <em>Status LED is GREEN.</em></code></p>
<p><code>Send <code>Null</code> just for sake of it:</code></p>
<p><code></p><div class="fragment"><div class="line">$ python.exe -m cmdline Null</div>
<div class="line">2020-05-03T19:10:51.044753,BridgeNull()</div>
</div><!-- fragment --><p></code></p>
<p><code><em>Status LED is GREEN.</em></code></p>
<p><code>Send <code>GetBridgeLED</code>. Should return <code>led_setting=1</code>.</code></p>
<p><code></p><div class="fragment"><div class="line">$ python.exe -m cmdline GetBridgeLed led_num=0</div>
<div class="line">2020-05-03T19:10:56.366519,BridgeGetBridgeLED(status=0, led_setting=1)</div>
</div><!-- fragment --><p></code></p>
<p><code><b>PASS</b>:</p><ul>
<li>Response is <code>led_setting=1</code></li>
<li><em>Status LED is GREEN</em></li>
</ul>
<p></code></p>
<p><code>Send <code>SetBridgeLED led_num=255 led_setting=255</code>.</code></p>
<p><code>This sends bytes <code>0x02</code>, <code>0xFF</code>, <code>0xFF</code>. None of these bytes are recognized, so:</code></p>
<p><code></p><ul>
<li>expect response is <code>None</code> and Status LED turns RED:<ul>
<li><code>None</code> means the firmware does not send a response back</li>
<li>expect <code>None</code> because I did not program a response to <code>SetBridgeLED</code> yet</li>
<li>all three bytes are handled as the <code>default</code> case of the <code>switch</code> block</li>
<li>the <code>default</code> case turns Status LED RED</li>
</ul>
</li>
</ul>
<p></code></p>
<p><code></p><div class="fragment"><div class="line">$ python.exe -m cmdline SetBridgeLED led_num=255 led_setting=255</div>
<div class="line">2020-05-03T19:11:05.782671,None</div>
</div><!-- fragment --><p></code></p>
<p><code></p><ul>
<li><b>PASS</b>:<ul>
<li>Response is <code>None</code></li>
<li><em>Status LED is RED</em></li>
</ul>
</li>
</ul>
<p></code></p>
<p><code>Send <code>GetBridgeLED</code>. Should return <code>led_setting=2</code>.</code></p>
<p><code></p><div class="fragment"><div class="line">$ python.exe -m cmdline GetBridgeLed led_num=0</div>
<div class="line">2020-05-03T19:11:10.128380,BridgeGetBridgeLED(status=0, led_setting=2)</div>
</div><!-- fragment --><p></code></p>
<p><code><b>PASS</b>:</p><ul>
<li>Response is <code>led_setting=2</code></li>
<li><em>Status LED is RED</em></li>
</ul>
<p></code></p>
<p><code>Send <code>Null</code> to reset LED to GREEN:</code></p>
<p><code></p><div class="fragment"><div class="line">$ python.exe -m cmdline Null</div>
<div class="line">2020-05-03T19:11:16.836114,BridgeNull()</div>
</div><!-- fragment --><p></code></p>
<p><code><em>Status LED is GREEN.</em></code></p>
<p><code>Send <code>GetBridgeLED</code>. Should return <code>led_setting=1</code> again.</code></p>
<p><code></p><div class="fragment"><div class="line">$ python.exe -m cmdline GetBridgeLed led_num=0</div>
<div class="line">2020-05-03T19:11:19.115907,BridgeGetBridgeLED(status=0, led_setting=1)</div>
</div><!-- fragment --><p></code></p>
<p><code><b>PASS</b>:</p><ul>
<li>Response is <code>led_setting=1</code></li>
<li><em>Status LED is GREEN</em></li>
</ul>
<p></code></p>
<p><code></p><h3>system test SetBridgeLED</h3>
<p></code></p>
<p><code></code></p>
<p><code>Here is the <code>main()</code> loop when I ran this system test:</code></p>
<p><code></p><div class="fragment"><div class="line"><span class="keywordtype">void</span> loop(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">while</span> (<a class="code" href="Usb_8h.html#a3081311c24ae86b950d6770c6a67cedb">UsbRxbufferIsEmpty</a>()); <span class="comment">// loop until cmd received</span></div>
<div class="line">    uint8_t <a class="code" href="Cmd_8h.html#ad48b407655ab242ef8b80e5ad0084399">cmd</a> = 0; <span class="comment">// initialize cmd as &quot;Null&quot;</span></div>
<div class="line">    <a class="code" href="Usb_8h.html#a4ed6f08cb0ec2adf9631d0932b30bbc5">UsbReadByte</a>(&amp;<a class="code" href="Cmd_8h.html#ad48b407655ab242ef8b80e5ad0084399">cmd</a>); <span class="comment">// read cmd</span></div>
<div class="line">    <span class="keywordflow">switch</span>(<a class="code" href="Cmd_8h.html#ad48b407655ab242ef8b80e5ad0084399">cmd</a>) <span class="comment">// look up cmd</span></div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Turn status LED red if cmd is not recognized.</span></div>
<div class="line">        <span class="keywordflow">default</span>:                    <a class="code" href="BiColorLed_8h.html#a2da32b453449ba56817344847d923a93">BiColorLedRed</a>(status_led);   <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="comment">// Null gets no response, but turns status LED green for now.</span></div>
<div class="line">        <span class="keywordflow">case</span> 0: <a class="code" href="UsbCmd_8h.html#ac2b6a4bbe89e22076102bc8a65c69ecd">NullCommand</a>();      <a class="code" href="BiColorLed_8h.html#a2401f7a281e7e5cbc5c76c074cf7fe6b">BiColorLedGreen</a>(status_led); <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> 1: <a class="code" href="UsbCmd_8h.html#a2be59832e776d1ef15b9d995e18cf26d">GetBridgeLED</a>(); <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> 2: <a class="code" href="UsbCmd_8h.html#a5b3a22b24f2d01d4fc902fc7fb7e9de9">SetBridgeLED</a>(); <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="comment">//  case 8: SetSensorConfig(); break;</span></div>
<div class="line">        <span class="comment">// default: ReplyCommandInvalid(); break;</span></div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p></code></p>
<p><code>Send command to turn off the status LED:</code></p>
<p><code></p><div class="fragment"><div class="line">$ python.exe -m cmdline SetBridgeLED led_num=0 led_setting=0</div>
<div class="line">2020-05-03T21:14:01.364061,BridgeSetBridgeLED(status=0)</div>
</div><!-- fragment --><p></code></p>
<p><code><b>PASS</b>: status LED turns off</code></p>
<p><code>Check GetBridgeLED returns <code>led_setting=0</code>:</code></p>
<p><code></p><div class="fragment"><div class="line">$ python.exe -m cmdline GetBridgeLed led_num=0</div>
<div class="line">2020-05-03T21:14:05.208334,BridgeGetBridgeLED(status=0, led_setting=0)</div>
</div><!-- fragment --><p></code></p>
<p><code>Send command to turn the status LED green:</code></p>
<p><code></p><div class="fragment"><div class="line">$ python.exe -m cmdline SetBridgeLED led_num=0 led_setting=1</div>
</div><!-- fragment --><p></code></p>
<p><code><b>PASS</b>: status LED turns green</code></p>
<p><code>Check GetBridgeLED returns <code>led_setting=1</code>:</code></p>
<p><code></p><div class="fragment"><div class="line">$ python.exe -m cmdline GetBridgeLed led_num=0</div>
<div class="line">2020-05-03T21:14:14.974757,BridgeGetBridgeLED(status=0, led_setting=1)</div>
</div><!-- fragment --><p></code></p>
<p><code>Send command to turn the status LED red:</code></p>
<p><code></p><div class="fragment"><div class="line">$ python.exe -m cmdline SetBridgeLED led_num=0 led_setting=2</div>
<div class="line">2020-05-03T21:14:18.531435,BridgeSetBridgeLED(status=0)</div>
</div><!-- fragment --><p></code></p>
<p><code><b>PASS</b>: status LED turns red</code></p>
<p><code>Check GetBridgeLED returns <code>led_setting=2</code>:</code></p>
<p><code></p><div class="fragment"><div class="line">$ python.exe -m cmdline GetBridgeLed led_num=0</div>
<div class="line">2020-05-03T21:14:21.380145,BridgeGetBridgeLED(status=0, led_setting=2)</div>
</div><!-- fragment --><p></code></p>
<p><code></p><h3>system test GetSensorLED</h3>
<p></code></p>
<p><code></code></p>
<p><code>Both LEDs on sensor board are green. Expect <code>led_setting=1</code> for both.</code></p>
<p><code></p><div class="fragment"><div class="line">$ python.exe -m cmdline GetSensorLED led_num=0</div>
<div class="line">2020-05-07T06:02:50.588743,SensorGetSensorLED(status=0, led_setting=1)</div>
</div><!-- fragment --><p></code></p>
<p><code></p><div class="fragment"><div class="line">$ python.exe -m cmdline GetSensorLED led_num=1</div>
<div class="line">2020-05-07T06:04:34.546605,SensorGetSensorLED(status=0, led_setting=1)</div>
</div><!-- fragment --><p></code></p>
<p><code>Sensor board only has led 0 and 1. Expect <code>status=1</code> (1 is ERROR) and <code>led_setting=255</code> (255 is PADDING) if I pass <code>led_num=2</code>.</code></p>
<p><code></p><div class="fragment"><div class="line">$ python.exe -m cmdline GetSensorLED led_num=2</div>
<div class="line">2020-05-07T06:06:24.061009,SensorGetSensorLED(status=1, led_setting=255)</div>
</div><!-- fragment --><p></code></p>
<p><code></p><h3>system test SetSensorLED</h3>
<p></code></p>
<p><code></code></p>
<p><code>Both LEDs on sensor board are green. Expect <code>led_setting=2</code> to turn one LED red.</code></p>
<p><code></p><div class="fragment"><div class="line">$ python.exe -m cmdline SetSensorLED led_num=0 led_setting=2</div>
<div class="line">2020-05-14T05:49:48.348288,SensorSetSensorLED(status=0)</div>
</div><!-- fragment --><p></code></p>
<p><code>Turn the other LED red.</code></p>
<p><code></p><div class="fragment"><div class="line">$ python.exe -m cmdline SetSensorLED led_num=1 led_setting=2</div>
<div class="line">2020-05-14T05:51:19.018410,SensorSetSensorLED(status=0)</div>
</div><!-- fragment --><p></code></p>
<p><code>Turn both LEDs back to green.</code></p>
<p><code></p><div class="fragment"><div class="line">$ python.exe -m cmdline SetSensorLED led_num=1 led_setting=1</div>
<div class="line">$ python.exe -m cmdline SetSensorLED led_num=0 led_setting=1</div>
<div class="line">2020-05-14T05:52:19.548047,SensorSetSensorLED(status=0)</div>
<div class="line">2020-05-14T05:52:52.624399,SensorSetSensorLED(status=0)</div>
</div><!-- fragment --><p></code></p>
<p><code>Turn both LEDs off.</code></p>
<p><code></p><div class="fragment"><div class="line">$ python.exe -m cmdline SetSensorLED led_num=1 led_setting=0</div>
<div class="line">$ python.exe -m cmdline SetSensorLED led_num=0 led_setting=0</div>
<div class="line">2020-05-14T05:53:43.891838,SensorSetSensorLED(status=0)</div>
<div class="line">2020-05-14T05:53:51.731680,SensorSetSensorLED(status=0)</div>
</div><!-- fragment --><p></code></p>
<p><code>Turn both LEDs green again.</code></p>
<p><code></p><div class="fragment"><div class="line">$ python.exe -m cmdline SetSensorLED led_num=1 led_setting=1</div>
<div class="line">$ python.exe -m cmdline SetSensorLED led_num=0 led_setting=1</div>
<div class="line">2020-05-14T05:54:49.939523,SensorSetSensorLED(status=0)</div>
<div class="line">2020-05-14T05:54:56.939379,SensorSetSensorLED(status=0)</div>
</div><!-- fragment --><p></code></p>
<p><code></p><h3>system test GetSensorConfig and SetSensorConfig</h3>
<p></code></p>
<p><code></code></p>
<p><code>Expect default configuration is:</code></p>
<p><code></p><ul>
<li><code>binning</code> = 1;</li>
<li><code>gain</code> = 1;</li>
<li><code>row_bitmap</code> = 31;</li>
</ul>
<p></code></p>
<p><code></p><div class="fragment"><div class="line">$ python.exe -m cmdline GetSensorConfig</div>
<div class="line">2020-05-15T03:57:30.367547,SensorGetSensorConfig(status=0, binning=1, gain=1, row_bitmap=31)</div>
</div><!-- fragment --><p></code></p>
<p><code>Change the configuration:</code></p>
<p><code></p><div class="fragment"><div class="line">$ python.exe -m cmdline SetSensorConfig binning=0 gain=5 row_bitmap=30</div>
<div class="line">2020-05-15T04:07:33.613819,SensorSetSensorConfig(status=0)</div>
<div class="line"> </div>
<div class="line">$ python.exe -m cmdline GetSensorConfig</div>
<div class="line">2020-05-15T04:07:39.208883,SensorGetSensorConfig(status=0, binning=0, gain=5, row_bitmap=30)</div>
</div><!-- fragment --><p></code></p>
<p><code>Try an invalid configuration by setting binning to 2. Expect status is 1 (ERROR).</code></p>
<p><code></p><div class="fragment"><div class="line">$ python.exe -m cmdline SetSensorConfig binning=2 gain=5 row_bitmap=30</div>
<div class="line">2020-05-15T04:09:09.196835,SensorSetSensorConfig(status=1)</div>
</div><!-- fragment --><p></code></p>
<p><code>Check that the configuration did not change.</code></p>
<p><code></p><div class="fragment"><div class="line">$ python.exe -m cmdline GetSensorConfig</div>
<div class="line">2020-05-15T04:10:18.475317,SensorGetSensorConfig(status=0,</div>
<div class="line">binning=0, gain=5, row_bitmap=30)</div>
</div><!-- fragment --><p></code></p>
<p><code></p><h3>system test GetExposure and SetExposure</h3>
<p></code></p>
<p><code></code></p>
<p><code>Initial exposure is 1ms. Expect status=0, cycles=50.</code></p>
<p><code></p><div class="fragment"><div class="line">$ python.exe -m cmdline GetExposure</div>
<div class="line">2020-05-15T18:31:13.646272,SensorGetExposure(status=0, cycles=50)</div>
</div><!-- fragment --><p></code></p>
<p><code>Set exposure to 10ms (500 20µs-ticks). Expect status=0.</code></p>
<p><code></p><div class="fragment"><div class="line">$ python.exe -m cmdline SetExposure cycles=500</div>
<div class="line">2020-05-15T20:12:56.027071,SensorSetExposure(status=0)</div>
</div><!-- fragment --><p></code></p>
<p><code>Check exposure. Expect status=0, cycles=500.</code></p>
<p><code></p><div class="fragment"><div class="line">$ python.exe -m cmdline GetExposure</div>
<div class="line">2020-05-15T20:13:06.457501,SensorGetExposure(status=0, cycles=500)</div>
</div><!-- fragment --><p></code></p>
<p><code></p><h3>system test CaptureFrame</h3>
<p></code></p>
<p><code></code></p>
<p><code></p><div class="fragment"><div class="line">$ python.exe -m cmdline CaptureFrame</div>
<div class="line">2020-05-16T06:46:46.992454,SensorCaptureFrame(status=0, num_pixels=392, pixels=[8653, 7711, 7675, 7964, 6932, 7475, 6939, 414, 0, 0, 134, 29, 0, 0, 20 08, 0, 0, 762, 1246, 911, 0, 399, 0, 601, 0, 0, 1032, 0, 0, 0, 1201, 1681, 248, 0, 348, 709, 100, 418, 0, 0, 0, 421, 0, 0, 0, 0, 759, 539, 948, 1250, 449, 0, 0, 97, 0, 307, 195, 272, 81, 0, 0, 0, 641, 0, 0, 0, 0, 0, 0, 0, 0, 221, 512, 762, 1365, 729, 0, 0, 0, 0, 0, 443, 0, 0, 72, 29, 0, 0, 118, 893, 0, 0, 0, 0, 0, 0, 0, 0, 116, 1743, 0, 0, 0, 1520, 64, 1371, 124, 0, 0, 0, 530, 167, 1, 416, 0, 0, 0, 0, 1544, 0, 0, 0, 0, 1036, 0, 851, 0, 0, 0, 667, 0, 546, 1212, 348, 0, 61, 0, 50, 267, 23, 942, 0, 0, 564, 211, 0, 1482, 91, 0, 0, 186, 730, 0, 0, 1272, 0, 0, 436, 122, 0, 0, 0, 283, 204, 104, 0, 0, 0, 451, 722, 0, 0, 80, 0, 0, 0, 0, 0, 433, 0, 1511, 0, 0, 310, 49, 0, 181, 0, 0, 0, 0, 0, 0, 100, 213, 0, 338, 349, 645, 156, 1110, 0, 0, 0, 0, 0, 48 3, 0, 774, 0, 0, 714, 0, 0, 0, 0, 712, 206, 0, 18, 0, 0, 189, 469, 0, 896, 0, 0, 0, 649, 528, 0, 0, 0, 539, 783, 0, 447, 0, 0, 0, 0, 0, 0, 0, 0, 691, 0, 259, 0, 848, 0, 0, 417, 683, 0, 0, 732, 613, 48, 341, 0, 0, 218, 0, 364, 0, 228, 0, 1427, 72, 0, 0, 160, 483, 0, 0, 0, 0, 308, 0, 288, 1261, 686, 0 , 0, 0, 0, 0, 0, 293, 0, 984, 224, 0, 191, 222, 0, 0, 0, 0, 808, 416, 601, 0, 0, 0, 202, 590, 658, 134, 227, 622, 806, 0, 0, 0, 473, 305, 0, 112, 0, 0 , 0, 32, 0, 0, 28, 797, 0, 18, 0, 504, 0, 0, 601, 362, 0, 814, 56, 1208, 230, 0, 0, 420, 0, 0, 0, 236, 0, 0, 0, 799, 16, 294, 272, 574, 0, 0, 0, 953, 0, 223, 0, 146, 1212, 0, 1040, 0, 0, 0, 0, 0, 0, 760, 400, 187, 0, 1865, 442, 638, 94, 112, 1284, 0, 0, 314, 385, 0, 133, 0, 371])</div>
</div><!-- fragment --><p></code></p>
<p><code></p><h2>TODO list for Sean</h2>
<p></code></p>
<p><code></p><ul>
<li>[ ] TODO: Sean add documentation for the <code>serial_number</code> and <code>device</code> parameters of <code>MicroSpecSimpleInterface</code><ul>
<li>[x] Sean is aware</li>
<li>document input is a string</li>
<li>document an example string: <code>CHROMATION091103</code></li>
</ul>
</li>
<li>[ ] TODO: Sean add list of commands in documentation or, better still, in the help for <code>microspec_cmdline.py</code><ul>
<li>[x] Sean is aware</li>
<li>this is actually just a wrapper for python to execute <code>cmdline.py</code> as a module</li>
<li>cd into <code>microspec/src/microspeclib/</code></li>
<li>execute as <code>python -m cmdline.py command key=val</code></li>
<li><code>python cmdline.py</code> also works</li>
<li><code>python cmdline.py GetBridgeLED led_num=0</code></li>
</ul>
</li>
<li>[ ] TODO: Sean add documentation explaining how to read the response<ul>
<li>[x] Sean is aware</li>
<li>nothing in the Sphinx HTML or the pydoc docstrings explains what the responses are</li>
<li><code>python cmdline.py GetBridgeLED led_num=0</code></li>
<li>has this response:</li>
<li><code>2020-04-29T19:02:37.952994,None</code> (from Cygwin bash)</li>
<li><code>2020-04-29T14:02:15.856620,None</code> (from PowerShell)</li>
<li>the correct time is 2:02PM</li>
<li>I'm not sure why running from Cygwin bash adds five hours to the time &ndash; the <code>date</code> utility works just fine and prints the correct time, and I'm invoking the Windows Python from Cygwin bash, so what gives?</li>
</ul>
</li>
<li>[ ] TODO: Sean: unexpected end of docstring in MicroSpecSimpleInterface.sendAndReceive()<ul>
<li>[x] Sean is aware</li>
<li>ends with phrase "but a reply that contains"</li>
</ul>
</li>
</ul>
<p></code></p>
<p><code></p><h1>Developer's Guide &ndash; navigate code base</h1>
<p></code></p>
<p><code></code></p>
<p><code>Here is how I navigate the firmware code base.</code></p>
<p><code></p><h2>Search code within Vim</h2>
<p></code></p>
<p><code></code></p>
<p><code></p><h3>cscope</h3>
<p></code></p>
<p><code></code></p>
<p><code>The Vim package from Cygwin is built with <code>cscope</code>.</code></p>
<p><code><em>I'd imagine most Vim builds have <code>cscope</code> because Vim tightly integrates <code>cscope</code>.</em></code></p>
<p><code>See the Vim help:</code></p>
<p><code></p><div class="fragment"><div class="line">:help cscope</div>
</div><!-- fragment --><p></code></p>
<p><code>See <code>cscope</code> configuration in my <code>~/.vim/vimrc</code>:</code></p>
<p><code></p><div class="fragment"><div class="line">if has(&quot;cscope&quot;)</div>
<div class="line">    set nocscopetag</div>
<div class="line">    set cscopequickfix=s-,d-,c-,t-,e-,i-,a-</div>
</div><!-- fragment --><p></code></p>
<p><code>Make a cscope database in the <code>./firmware</code> folder.</code></p>
<p><code></p><div class="fragment"><div class="line">$ cd ./firmware/</div>
<div class="line">$ cscope -R -b</div>
</div><!-- fragment --><p></code></p>
<p><code>This creates/overwrites the <code>cscope.out</code> file in <code>./firmware</code>. I update the <code>cscope.out</code> file regularly. I made shortcut <code>;cu</code>. The shortcut updates my tags file as well.</code></p>
<p><code>In Vim, updated connection to the new <code>cscope.out</code> file:</code></p>
<p><code></p><div class="fragment"><div class="line">: cscope reset</div>
</div><!-- fragment --><p></code></p>
<p><code>The first time <code>cscope.out</code> is made, create the connection and kill any existing connections. There is a bit to do here. I made a <code>;cs</code> shortcut for this. See details in my <code>~/.vim/vimrc</code>:</code></p>
<p><code></p><div class="fragment"><div class="line">function! CscopeCreateConnection()</div>
</div><!-- fragment --><p></code></p>
<p><code>Search with cscope using <code>:cscope find</code>.</code></p>
<p><code></p><ul>
<li>'s' symbol: find all references to <code>symbol_name</code></li>
</ul>
<p></code></p>
<p><code></p><div class="fragment"><div class="line">:cscope find s symbol_name</div>
</div><!-- fragment --><p></code></p>
<p><code>As a Vim shortcut:</code></p>
<p><code></p><div class="fragment"><div class="line">nnoremap &lt;C-&gt;s :cs find s &lt;cword&gt;&lt;CR&gt;</div>
</div><!-- fragment --><p></code></p>
<p><code></p><ul>
<li>'g' global: find the global definition of <code>&lt;cword&gt;</code> under the cursor</li>
</ul>
<p></code></p>
<p><code></p><div class="fragment"><div class="line">:cscope find g symbol_name</div>
</div><!-- fragment --><p></code></p>
<p><code></p><div class="fragment"><div class="line">nnoremap &lt;C-&gt;g :cs find g &lt;cword&gt;&lt;CR&gt;</div>
</div><!-- fragment --><p></code></p>
<p><code></p><ul>
<li>'c' calls: find all calls to the function name under cursor</li>
<li>'d' dependencies: find functions called by function under cursor</li>
<li>'t' text: find all instances of the text under cursor</li>
<li>'e' egrep: egrep search for the word under cursor</li>
<li>'f' file: open the filename under cursor</li>
<li>'i' includes: find files that include the filename under cursor</li>
</ul>
<p></code></p>
<p><code>Then use the Vim quickfix window to navigate through the <code>cscope</code> results.</code></p>
<p><code></p><div class="fragment"><div class="line">:copen</div>
</div><!-- fragment --><p></code></p>
<p><code></p><h4>cscope has no exclude option</h4>
<p></code></p>
<p><code></code></p>
<p><code>Instead of an exclude create a <code>cscope.files</code> file that lists the files to include. Use double-quotes for file names that include spaces.</code></p>
<p><code>Or use <code>-inamefile</code> to specify an alternate file with a list of file names to include. Use <code>-i-</code> to get the file list from standard input. Use <code>find</code> to generate the file list from a regexp.</code></p>
<p><code></p><h3>tags</h3>
<p></code></p>
<p><code></code></p>
<p><code>Make a tags file in the <code>./firmware</code> folder.</code></p>
<p><code></p><div class="fragment"><div class="line">$ cd ./firmware/</div>
<div class="line">$ ctags --c-kinds=+l --exclude=Makefile -R .</div>
</div><!-- fragment --><p></code></p>
<p><code></p><ul>
<li><code>--c-kinds=+l</code> includes local variables in the <code>cscope.out</code> file</li>
<li><code>-R</code> recursive</li>
<li><code>.</code> start in the current folder</li>
</ul>
<p></code></p>
<p><code>Update this file with the same command to overwrite it.</code></p>
<p><code>I use Vim shortcut <code>;cu</code> which also updates the <code>cscope.out</code> file.</code></p>
<p><code></p><h3>vimgrep</h3>
<p></code></p>
<p><code></code></p>
<p><code></p><div class="fragment"><div class="line">:vimgreap /search_term/ files_to_search</div>
</div><!-- fragment --><p></code></p>
<p><code>Example:</code></p>
<p><code></p><div class="fragment"><div class="line">:vimgrep /SetBit(Flag_SpiFlags/ lib/**/*.[ch]</div>
</div><!-- fragment --><p></code></p>
<p><code>Find all occurrences of <code>SetBit(Flag_SpiFlags</code> in every <code>.c</code> and <code>.h</code> file in the <code>lib/</code> folder, including sub-folders.</code></p>
<p><code>Open a quickfix window and navigate the results.</code></p>
<p><code></p><div class="fragment"><div class="line">:copen</div>
</div><!-- fragment --><p></code></p>
<p><code>Similar to using <code>cscope</code>.</code></p>
<p><code>Use <code>cscope</code> to when the symbol name is known but its purpose/definition/dependencies are unknown.</code></p>
<p><code>This is the scenario:</code></p>
<p><code></p><ul>
<li>I am looking at a specific line of code</li>
<li>I see a symbol I want to know more about</li>
</ul>
<p></code></p>
<p><code>Use <code>vimgrep</code> when the symbol name itself is not known yet.</code></p>
<p><code>This is the scenario:</code></p>
<p><code></p><ul>
<li>I want to determine a variable naming convention</li>
<li>or I just want to check if a certain variable name is already used</li>
</ul>
<p></code></p>
<p><code>Another example: search the active Vim file for a certain word:</code></p>
<p><code></p><div class="fragment"><div class="line">:vimgrep /cscope/ %</div>
</div><!-- fragment --><p></code></p>
<p><code>This is superior to the usual Vim search (with <code>/</code>) because <code>:copen</code> displays all of the lines where the search term occurs.</code></p>
<p><code>And this is useful when a cscope database does not exist.</code></p>
<p><code></p><h1>Developer's Guide &ndash; update documentation</h1>
<p></code></p>
<p><code></code></p>
<p><code>Here is how I update documentation.</code></p>
<p><code>There is one top level Doxyfile</code></p>
<p><code></p><ul>
<li><code>./Doxyfile</code></li>
</ul>
<p></code></p>
<p><code>Create a doxygen folder at any level to document with Doxygen</code></p>
<p><code></p><ul>
<li><code>./doxygen</code></li>
<li><code>./firmware/doxygen</code></li>
</ul>
<p></code></p>
<p><code>Optionally, add a second <code>Doxyfile</code>:</code></p>
<p><code></p><ul>
<li><code>./firmware/Doxyfile</code></li>
</ul>
<p></code></p>
<p><code>I decided to add a second <code>Doxyfile</code> to have different page titles and main page files for the <code>./doxygen</code> and <code>./firmware/doxygen</code>.</code></p>
<p><code></p><h2>Doxyfile customization</h2>
<p></code></p>
<p><code></code></p>
<p><code>Generate the default Doxyfile:</code></p>
<p><code></p><div class="fragment"><div class="line">$ doxygen -g</div>
</div><!-- fragment --><p></code></p>
<p><code>The <code>./Doxyfile</code> is the default Doxyfile with the following changes:</code></p>
<p><code></p><div class="fragment"><div class="line">PROJECT_NAME           = &quot;dev-kit&quot;</div>
<div class="line">PROJECT_BRIEF          = &quot;Python-compatible Chromation Spectrometer dev-kit&quot;</div>
<div class="line">OUTPUT_DIRECTORY       = ./doxygen</div>
<div class="line">RECURSIVE              = YES</div>
<div class="line">OPTIMIZE_OUTPUT_FOR_C  = YES</div>
<div class="line">EXTRACT_STATIC         = YES</div>
<div class="line">OPTIMIZE_OUTPUT_JAVA   = NO</div>
<div class="line">EXCLUDE                = doc/ \</div>
<div class="line">                        hardware-drawings/ \</div>
<div class="line">                        labview/ \</div>
<div class="line">                        system-design-sketches/ \</div>
<div class="line">                        temp/ \</div>
<div class="line">                        firmware/temp/ \</div>
<div class="line">                        firmware/AssemblyExample.md \</div>
<div class="line">                        firmware/Earhart-snippet.c \</div>
<div class="line">                        firmware/README-firmware.md</div>
<div class="line">EXTRACT_ALL            = NO</div>
<div class="line">WARN_IF_UNDOCUMENTED   = YES</div>
<div class="line">USE_MDFILE_AS_MAINPAGE = README.md</div>
<div class="line">HTML_EXTRA_STYLESHEET  = &quot;doxygen/doxygen-dark-theme/custom.css&quot; \</div>
<div class="line">                         &quot;doxygen/doxygen-dark-theme/custom_dark_theme.css&quot;</div>
</div><!-- fragment --><p></code></p>
<p><code>The <code>./firmware/Doxyfile</code> is the <code>./Doxyfile</code> with the following changes:</code></p>
<p><code></p><div class="fragment"><div class="line">PROJECT_NAME           = &quot;firmware&quot;</div>
<div class="line">PROJECT_NUMBER         = &quot;v0&quot;</div>
<div class="line">PROJECT_BRIEF          = &quot;Protocol compatible with microspec&quot;</div>
<div class="line">EXCLUDE                = doc/ \</div>
<div class="line">                        temp/</div>
<div class="line">USE_MDFILE_AS_MAINPAGE = README-firmware.md</div>
</div><!-- fragment --><p></code></p>
<p><code></p><ul>
<li><code>PROJECT_NAME</code><ul>
<li>one-word project name</li>
<li>appears as title on every page</li>
</ul>
</li>
<li><code>PROJECT_BRIEF</code><ul>
<li>optional one-liner</li>
<li>appears at the top of every page</li>
</ul>
</li>
<li><code>RECURSIVE</code><ul>
<li><code>YES</code>: look inside project folders for source code</li>
</ul>
</li>
<li><code>EXTRACT_STATIC</code><ul>
<li>include documentation for <code>static</code> functions</li>
</ul>
</li>
<li><code>OPTIMIZE_OUTPUT_JAVA</code><ul>
<li><code>YES</code>: if project only contains Python code or Java code</li>
</ul>
</li>
<li><code>USE_MDFILE_AS_MAINPAGE</code><ul>
<li><code>README.md</code>: use the <code>README.md</code> file in the same folder that as the <code>doxygen</code> folder</li>
<li>this means the <code>doxygen</code> for the top-level and the <code>doxygen</code> for <code>./firmware</code> have their own <code>README.md</code> files which appear as the main page</li>
</ul>
</li>
</ul>
<p></code></p>
<p><code>Use Vim shortcuts <code>;DU</code> to create/update doxygen and <code>;DV</code> to view in the browser.</code></p>
<p><code><code>;DU</code> is equivalent to <code>bash</code> command:</code></p>
<p><code></p><div class="fragment"><div class="line">$ doxygen ./firmware/Doxyfile</div>
</div><!-- fragment --><p></code></p>
<p><code><code>;DV</code> is equivalent to <code>bash</code> command:</code></p>
<p><code></p><div class="fragment"><div class="line">$ explorer &quot;$(cygpath -wa ./firmware/doxygen/html/index.html)&quot;</div>
</div><!-- fragment --><p></code></p>
<p><code></p><h2>Create a doxygen folder before running doxygen</h2>
<p></code></p>
<p><code></code></p>
<p><code>The repo <em>does not contain</em> a <code>doxygen</code> folder after the initial clone. Create empty <code>doxygen</code> folders before running <code>;DU</code>.</code></p>
<p><code></p><div class="fragment"><div class="line">$ mkdir ./doxygen # top-level documentation</div>
<div class="line">$ mkdir ./firmware/doxygen # documentation for firmware only</div>
</div><!-- fragment --><p></code></p>
<p><code>The importance of making a <code>doxygen</code> folder is that my Doxyfile looks for this folder:</code></p>
<p><code></p><div class="fragment"><div class="line">OUTPUT_DIRECTORY       = ./doxygen</div>
</div><!-- fragment --><p></code></p>
<p><code>If a <code>doxygen</code> folder does not exist in the <code>pwd</code>, doxygen does not generate documentation.</code></p>
<p><code></p><h2>Minimum Doxyfile and doxygen folder to proceed</h2>
<p></code></p>
<p><code></code></p>
<p><code>At a minimum, have <code>./Doxyfile</code> and <code>./firmware/doxygen/</code>. Then the <code>bash</code> command to make the documentation is simply:</code></p>
<p><code></p><div class="fragment"><div class="line">$ doxygen Doxyfile</div>
</div><!-- fragment --><p></code></p>
<p><code></p><h2>Top-level and firmware-level versions of the documentation</h2>
<p></code></p>
<p><code></code></p>
<p><code>I created the top-level <code>./doxygen</code> to get a top-level version of the documentation that excluded details in the <code>firmware</code> folder's markdown files. This is for the wider Chromation audience.</code></p>
<p><code>I created the <code>./doxygen/Doxyfile</code> to make a distinct <code>main page</code> and <code>title</code> for the <code>./firmware/doxygen</code> firmware-specific version of the documentation. This is for me during development of the firmware.</code></p>
<p><code></p><h2>Vim shortcut to make doxygen docstrings from unit test results</h2>
<p></code></p>
<p><code> My shortcut <code>;xdc</code> takes unit test results and formats them as a Doxygen docstring. The pneumonic is <code>x</code> for transform, <code>d</code> for doxygen docstring, and <code>c</code> for C. Shortcut <code>;xdp</code> makes Python docstrings.</code></p>
<p><code>Place the cursor in the Vim buffer with the test results <code>.md</code> file. <code>;xdc</code> puts the docstring in the default register. Navigate to the top of the function definition and paste.</code></p>
<p><code></p><h2><code>;xdc</code> (automated) Doxygen example</h2>
<p></code></p>
<p><code></code></p>
<p><code><code>;mktgc</code> generated the following test result output:</code></p>
<p><code></p><div class="fragment"><div class="line">test/test_runner.c:45:ReadLedState_returns_OFF_if_LED_is_off:PASS</div>
<div class="line">test/test_runner.c:46:ReadLedState_returns_GREEN_if_LED_is_on_and_green:PASS</div>
<div class="line">test/test_runner.c:47:ReadLedState_returns_RED_if_LED_is_on_and_red:PASS</div>
</div><!-- fragment --><p></code></p>
<p><code>With the cursor in the markdown file showing, the output, <code>;xdc</code> copied the doxygen docstring to the clipboard.</code></p>
<p><code>Withe the cursor on the opening <code>{</code> of the function body definition, pasting inserts the docstring:</code></p>
<p><code></p><div class="fragment"><div class="line"><span class="keyword">inline</span> uint8_t <a class="code" href="UsbCmd_8h.html#ab54bb71cd582d7ce2e3c5a104bf66478">ReadLedState</a>(<span class="keywordtype">void</span>) <span class="comment">// -&gt; led_state</span></div>
<div class="line">{</div>
</div><!-- fragment --><p></code></p>
<p><code>The final line of docstring is added by hand.</code></p>
<p><code>Doxygen automatically turns the file name <code><a class="el" href="StatusCodes_8h.html">StatusCodes.h</a></code> into a link.</code></p>
<p><code></p><h2>Manual Doxygen example</h2>
<p></code></p>
<p><code></code></p>
<p><code>Here is an example documenting source file <code><a class="el" href="StatusCode_8h.html">StatusCode.h</a></code>. The documentation is accessed in the HTML from:</code></p>
<p><code></p><div class="fragment"><div class="line">Files</div>
<div class="line">    File List</div>
<div class="line">        lib</div>
<div class="line">            src</div>
<div class="line">                StatusCode.h</div>
</div><!-- fragment --><p></code></p>
<p><code>Following this tree opens the <code><a class="el" href="StatusCode_8h.html">StatusCode.h</a> File Reference</code>.</code></p>
<p><code>The documentation below appears in the HTML under the heading <code>Detailed Description</code> at the end of <code><a class="el" href="StatusCode_8h.html">StatusCode.h</a> File Reference</code>.</code></p>
<p><code>```c /** </code></p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<div class="ttc" id="aUsb_8h_html_a4ed6f08cb0ec2adf9631d0932b30bbc5"><div class="ttname"><a href="Usb_8h.html#a4ed6f08cb0ec2adf9631d0932b30bbc5">UsbReadByte</a></div><div class="ttdeci">uint8_t UsbReadByte(uint8_t *pbyte)</div><div class="ttdef"><b>Definition:</b> Usb.h:262</div></div>
<div class="ttc" id="aUsbCmd_8h_html_a2be59832e776d1ef15b9d995e18cf26d"><div class="ttname"><a href="UsbCmd_8h.html#a2be59832e776d1ef15b9d995e18cf26d">GetBridgeLED</a></div><div class="ttdeci">void GetBridgeLED(void)</div><div class="ttdef"><b>Definition:</b> UsbCmd.h:52</div></div>
<div class="ttc" id="aUsbCmd_8h_html_ab54bb71cd582d7ce2e3c5a104bf66478"><div class="ttname"><a href="UsbCmd_8h.html#ab54bb71cd582d7ce2e3c5a104bf66478">ReadLedState</a></div><div class="ttdeci">uint8_t ReadLedState(void)</div><div class="ttdef"><b>Definition:</b> UsbCmd.h:29</div></div>
<div class="ttc" id="aUsb_8h_html_a3081311c24ae86b950d6770c6a67cedb"><div class="ttname"><a href="Usb_8h.html#a3081311c24ae86b950d6770c6a67cedb">UsbRxbufferIsEmpty</a></div><div class="ttdeci">bool UsbRxbufferIsEmpty(void)</div><div class="ttdef"><b>Definition:</b> Usb.h:237</div></div>
<div class="ttc" id="aCmd_8h_html_ad48b407655ab242ef8b80e5ad0084399"><div class="ttname"><a href="Cmd_8h.html#ad48b407655ab242ef8b80e5ad0084399">cmd</a></div><div class="ttdeci">const uint8_t cmd</div><div class="ttdoc">Keys in the command lookup table are type cmd.</div><div class="ttdef"><b>Definition:</b> Cmd.h:27</div></div>
<div class="ttc" id="aBiColorLed_8h_html_a2da32b453449ba56817344847d923a93"><div class="ttname"><a href="BiColorLed_8h.html#a2da32b453449ba56817344847d923a93">BiColorLedRed</a></div><div class="ttdeci">void BiColorLedRed(bicolorled_num led)</div><div class="ttdef"><b>Definition:</b> BiColorLed.h:42</div></div>
<div class="ttc" id="aBiColorLed_8h_html_a2401f7a281e7e5cbc5c76c074cf7fe6b"><div class="ttname"><a href="BiColorLed_8h.html#a2401f7a281e7e5cbc5c76c074cf7fe6b">BiColorLedGreen</a></div><div class="ttdeci">void BiColorLedGreen(bicolorled_num led)</div><div class="ttdef"><b>Definition:</b> BiColorLed.h:35</div></div>
<div class="ttc" id="aUsbCmd_8h_html_ac2b6a4bbe89e22076102bc8a65c69ecd"><div class="ttname"><a href="UsbCmd_8h.html#ac2b6a4bbe89e22076102bc8a65c69ecd">NullCommand</a></div><div class="ttdeci">void NullCommand(void)</div><div class="ttdef"><b>Definition:</b> UsbCmd.h:49</div></div>
<div class="ttc" id="aUsbCmd_8h_html_a5b3a22b24f2d01d4fc902fc7fb7e9de9"><div class="ttname"><a href="UsbCmd_8h.html#a5b3a22b24f2d01d4fc902fc7fb7e9de9">SetBridgeLED</a></div><div class="ttdeci">void SetBridgeLED(void)</div><div class="ttdef"><b>Definition:</b> UsbCmd.h:81</div></div>
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
