<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Mike Gazes" />
  <title>Communication Protocol</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <link rel="stylesheet" href="pandoc.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header id="title-block-header">
<h1 class="title">Communication Protocol</h1>
<p class="author">Mike Gazes</p>
<p class="date">August 1st, 2019</p>
</header>
<nav id="TOC">
<ul>
<li><a href="#summary">Summary</a></li>
</ul>
</nav>
<h1 id="summary">Summary</h1>
<ul>
<li><strong>USB Host</strong> communicates with the <strong>sensor-interface</strong> via the <strong>usb-bridge</strong></li>
<li>all action starts with the USB Host</li>
<li>USB Host sends a command to the usb-bridge</li>
<li>usb-bridge passes the command to the sensor-interface</li>
<li>the number of bytes in the command depends on the command</li>
<li>the first byte of the command is <em>always</em> the <code>spi_CmdFn_key</code></li>
<li>given the command key, the sensor-interface knows how many bytes are in the message
<ul>
<li>this is hard-coded into whichever function the <code>key</code> jumps to</li>
</ul></li>
<li>after it receives all bytes, the sensor interface:
<ul>
<li>executes the command (if it is a command to do something)</li>
<li>sends a response to the usb-bridge</li>
</ul></li>
<li>sensor-interface responds to <em>all</em> messages, even if the command does not require the sensor-interface to return sensor data</li>
<li>sensor-interface is a SpiSlave, so it cannot directly respond</li>
<li>sensor-interface signals to usb-bridge when it is ready to respond</li>
<li>then the usb-bridge sends dummy bytes to read the data from the sensor-interface</li>
<li>there are two ways to send the <strong>data-ready</strong> signal</li>
<li>the old <strong>4-wire</strong> way:
<ul>
<li><code>Spi_Miso</code> is driven low</li>
<li>usb-bridge (SpiMaster) then waits for <code>Spi_Miso</code> to go high before it starts the transmission</li>
</ul></li>
<li>new <strong>5-wire</strong> way:
<ul>
<li>signal is on <code>Spi_DataReady</code> (net <code>DR</code> on EAGLE schematic)</li>
<li>I have no idea yet exactly what this signal will do</li>
</ul></li>
<li>usb-bridge starts reading the response, but does not know beforehand how long the response will be</li>
<li>usb-bridge uses the <strong>first two bytes</strong> of this response to determine the number of bytes in the response
<ul>
<li>these two bytes form a 16-bit word, MSB first</li>
</ul></li>
<li>these two bytes are necessary because the sensor-interface might have had an error
<ul>
<li>example: the usb-bridge thinks it is requesting frame data, but actually sends an invalid command</li>
<li>sensor-interface responds to an invalid command with two bytes: [StatusInvalid, <code>invalid_cmd</code>]</li>
<li>usb-bridge expects 784 bytes</li>
<li>instead, sensor-interface first sends [0x00, 0x02] indicating that only two bytes are coming back</li>
<li>then it sends the two bytes: [StatusInvalid, <code>invalid_cmd</code>]</li>
<li>so a total of four bytes are sent:
<ul>
<li>two bytes of message length</li>
<li>two bytes of actual message</li>
</ul></li>
</ul></li>
<li>between every byte, the sensor-interface sends a <em>Data-Ready</em> signal:
<ul>
<li>SPI data register is not double-buffered</li>
<li>SPI slave cannot load next byte until this transfer is finished</li>
<li>SpiMaster has to wait for SpiSlave to load next byte before it starts the next transmission</li>
</ul></li>
<li>in 4-wire SPI:
<ul>
<li>the usb-bridge must not attempt any other SPI communication while it waits for a SpiSlave response because <em>Data-Ready</em> is a SPI pin</li>
</ul></li>
<li>in 5-wire SPI:
<ul>
<li>the usb-bridge can do whatever it wants because <em>Data-Ready</em> is not a SPI bus wire, and the sensor-interface will sit and wait with its data ready until the usb-bridge reads it</li>
</ul></li>
<li>after receiving the message, the usb-bridge passes it to the USB Host</li>
<li>usb-bridge pushes all data from sensor-interface to USB Host, including the 2-byte header from the sensor-interface stating how many bytes it is sending</li>
<li>see the rest of section <code>Protocol</code> in <code>LIS-770i/doc/book/spi-slave-data-ready-signal.md</code> to see how I intend to handle a timeout</li>
</ul>
</body>
</html>
