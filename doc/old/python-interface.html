<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Mike Gazes" />
  <meta name="dcterms.date" content="2019-08-02" />
  <title>Python Interface</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <link rel="stylesheet" href="pandoc.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header id="title-block-header">
<h1 class="title">Python Interface</h1>
<p class="author">Mike Gazes</p>
<p class="date">August 2, 2019</p>
</header>
<nav id="TOC">
<ul>
<li><a href="#usb-communication-as-a-com-port-in-windows">USB communication as a COM port in Windows</a><ul>
<li><a href="#context">Context</a><ul>
<li><a href="#use-pyserial">Use <code>pyserial</code></a></li>
<li><a href="#pyserial-does-not-need-a-com-string"><code>pyserial</code> does not need a <code>COM</code> string</a></li>
<li><a href="#vcp-sees-serial-number">VCP sees <code>Serial Number</code></a></li>
<li><a href="#leave-the-default-usb-identifiers-in-the-ftdi-.inf-file">Leave the default USB identifiers in the FTDI <code>.inf</code> file</a></li>
</ul></li>
<li><a href="#set-the-serial-number">Set the serial number</a></li>
<li><a href="#make-ftdi-device-visible-as-a-generic-com-port">Make FTDI device visible as a generic COM port</a></li>
<li><a href="#script-examples">Script examples</a></li>
</ul></li>
</ul>
</nav>
<h1 id="usb-communication-as-a-com-port-in-windows">USB communication as a COM port in Windows</h1>
<h2 id="context">Context</h2>
<p>The FTDI device on our <code>usb-bridge</code> is accessible from the USB Host in two ways:</p>
<ul>
<li>FTDI D2XX API</li>
<li>generic COM port (VCP)</li>
</ul>
<p>We use the FTDI D2XX API for LabVIEW programs. Moving forward, we are switching from LabVIEW to Python. We are, therefore, switching from D2XX to the generic COM port interface:</p>
<ul>
<li>I cannot find a stable <code>d2xx</code> python library solution</li>
<li>the extra functionality offered by D2XX is not compelling enough to write our own <code>d2xx</code> library</li>
</ul>
<h3 id="use-pyserial">Use <code>pyserial</code></h3>
<ul>
<li><code>pyserial</code> is the de facto standard Python serial library</li>
<li><code>pyserial</code> is compatible with different operating systems</li>
</ul>
<h3 id="pyserial-does-not-need-a-com-string"><code>pyserial</code> does not need a <code>COM</code> string</h3>
<p>What about the annoyance of having to open a Windows Device Manager and plug/unplug the USB device to figure out which device is on which COM port?</p>
<ul>
<li><code>pyserial</code> has a <code>grep</code> function that takes the serial number and returns a <code>port</code> object</li>
<li><code>pyserial</code> can then open/close the <code>port</code> object without ever having to use the <code>COM</code> string explicitly</li>
</ul>
<h3 id="vcp-sees-serial-number">VCP sees <code>Serial Number</code></h3>
<ul>
<li>the essential serial commands are available with VCP</li>
<li>VCP cannot access <em>all</em> the USB Description Strings that D2XX can access:
<ul>
<li><code>Product Description</code> is not visible</li>
<li><code>Manufacturer</code> is not visible</li>
</ul></li>
<li>but VCP can access <code>Serial Number</code></li>
<li><code>Serial Number</code> is all we need for identifying spectrometer dev kits on the USB Host</li>
</ul>
<h3 id="leave-the-default-usb-identifiers-in-the-ftdi-.inf-file">Leave the default USB identifiers in the FTDI <code>.inf</code> file</h3>
<p>There is a COM port variable named <code>manufacturer</code> but this actually comes from the <code>.inf</code> file installed with the USB driver. FTDI wants you to change this. This FTDI doc shows where the fields are in <code>FT_Prog</code>:</p>
<p><a href="https://www.ftdichip.com/Support/Documents/AppNotes/AN_124_User_Guide_For_FT_PROG.pdf" class="uri">https://www.ftdichip.com/Support/Documents/AppNotes/AN_124_User_Guide_For_FT_PROG.pdf</a></p>
<p>And this doc explains what you’re supposed to change:</p>
<p><a href="https://www.ftdichip.com/Support/Documents/TechnicalNotes/TN_102_OEM_Technical_Support_Requirements_for_FTDI_Products.pdf" class="uri">https://www.ftdichip.com/Support/Documents/TechnicalNotes/TN_102_OEM_Technical_Support_Requirements_for_FTDI_Products.pdf</a></p>
<p>But changing these values voids the security certificate:</p>
<blockquote>
<p>It is important to note that the device drivers in this example are shown in Figures 2 and 3 as “Not digitally signed”. Any time there are edits performed on any of the device driver files, it will invalidate the WHQL signature. Re-certification by the OEM is possible. Refer to the <code>AN_101_WHQL_Certified_Driver_Process(FT_000063)</code>.</p>
</blockquote>
<ul>
<li>and that would sketch out customers</li>
<li>and since no one gives a fuck anyway, just leave it as-is:
<ul>
<li><code>manufacturer</code> shows up as FTDI, not a big deal</li>
</ul></li>
</ul>
<p>This is just <code>eval kit hardware</code>. If it <em>were</em> a consumer product, then we’d want to change this and do it right.</p>
<p>Doing it right requires paying for the security certificate mojo:</p>
<p><a href="https://www.ftdichip.com/Support/Documents/AppNotes/AN_101_Submitting_Modified_FTDI_Drivers_for_Windows_Hardware_Certification.pdf" class="uri">https://www.ftdichip.com/Support/Documents/AppNotes/AN_101_Submitting_Modified_FTDI_Drivers_for_Windows_Hardware_Certification.pdf</a></p>
<h2 id="set-the-serial-number">Set the serial number</h2>
<ul>
<li>I leave the <code>Product Description</code> as-is so that my LabVIEW code does not have to change: it still gets <code>ChromationSpect-0643-01</code></li>
<li>but now I put <code>CHROMATION123456</code> in FTDI <code>serial_number</code></li>
<li>when <code>pyserial</code> scans the USB ports, it can <code>grep</code> (awesome!) for the serial number and return a <code>port</code> object</li>
<li>I can tell that <code>port</code> object to open up without ever having to use the <code>COM</code> string explicitly</li>
<li>this <em>should</em> make the find-and-open code cross-platform</li>
<li>other change in <code>FT_Prog</code> is the manufacturer</li>
<li>change manufacturer from <code>FTDI</code> to <code>CH</code>
<ul>
<li>does not impact <code>Load VCP</code> users, e.g., what you can see from <code>pyserial</code></li>
<li>does not impact my LabVIEW code since I never look at the manufacturer field</li>
<li>but it helps with the 44 character limit:</li>
<li>Product Description + manufacturer + serial number cannot exceed 44 characters</li>
<li>serial number is supposed to be 16 characters: <code>CHROMATION123456</code></li>
</ul></li>
</ul>
<h2 id="make-ftdi-device-visible-as-a-generic-com-port">Make FTDI device visible as a generic COM port</h2>
<ul>
<li>enable <code>Load VCP</code> in Windows Device Manager for FTDI bridge IC:</li>
</ul>
<h2 id="script-examples">Script examples</h2>
<ul>
<li>serial commands are encapsulated in functions</li>
<li>functions are all very short thanks to generators and list comprehensions</li>
<li>even the final plotting code is relatively short, as plotting code goes</li>
<li>up until 3AM figuring out a snappy live updating matplotlib</li>
<li>snag here with globals to revisit later</li>
</ul>
</body>
</html>
